var _platform="unknown";(function(){if(typeof enyo!=="undefined"){_platform="enyo"}else if(typeof environment!=="undefined"){_platform="rhino"}else if(typeof Qt!=="undefined"){_platform="qt"}else if(typeof process!=="undefined"||typeof require!=="undefined"){_platform="nodejs"}else if(typeof window!=="undefined"){_platform=typeof PalmSystem!=="undefined"?"webos":"browser"}})();var PackedBuffer=PackedBuffer||(_platform==="nodejs"||_platform==="qt"?require("./PackedBuffer.js"):undefined);var ZoneInfoFile=function(path){var that=this;switch(_platform){case"nodejs":var fs=require("fs");var bytes=new Buffer(fs.readFileSync(path));var byteArray=new Uint8Array(bytes);this._parseInfo(byteArray);break;case"qt":var fr=require("./ilib.js").getLoader().fr;var bytes=fr.readBinary(path);this._parseInfo(bytes);break;default:var req=new XMLHttpRequest();req.open("GET","file:"+path,false);req.responseType="arraybuffer";req.onload=function(e){var byteArray=new Uint8Array(req.response);that._parseInfo(byteArray)};req.onerror=function(e){throw"Cannot load file "+path};req.send();break}};ZoneInfoFile.prototype._parseInfo=function(buffer){var packed=new PackedBuffer(buffer);if(packed.getString(4)!="TZif"){throw"file format not recognized"}else{packed.skip(16);var tzh_ttisgmtcnt=packed.getLong();var tzh_ttisstdcnt=packed.getLong();var tzh_leapcnt=packed.getLong();var tzh_timecnt=packed.getLong();var tzh_typecnt=packed.getLong();var tzh_charcnt=packed.getLong();this.transitionTimes=tzh_timecnt?packed.getLongs(tzh_timecnt):[];this.transitionTimes=this.transitionTimes.map(function(item){return item*1e3});this.ruleIndex=tzh_timecnt?packed.getUnsignedBytes(tzh_timecnt):[];this.zoneInfo=[];for(var i=0;i<tzh_typecnt;i++){this.zoneInfo.push({offset:Math.floor(packed.getLong()/60),isdst:!!packed.getByte(),abbreviationIndex:packed.getByte()})}var allAbbreviations=packed.getString(tzh_charcnt);for(var i=0;i<tzh_typecnt;i++){var abbreviation=allAbbreviations.substring(this.zoneInfo[i].abbreviationIndex);this.zoneInfo[i].abbreviation=abbreviation.substring(0,abbreviation.indexOf("\x00"))}if(tzh_leapcnt){packed.skip(tzh_leapcnt*2)}if(tzh_ttisstdcnt){packed.skip(tzh_ttisstdcnt)}if(tzh_ttisgmtcnt){packed.skip(tzh_ttisgmtcnt)}var that=this;this.ruleIndex=this.ruleIndex.map(function(item){return{offset:that.zoneInfo[item].offset,isdst:that.zoneInfo[item].isdst,abbreviation:that.zoneInfo[item].abbreviation}});for(var i=0;i<tzh_timecnt;i++){if(i>0&&this.ruleIndex[i].isdst){this.ruleIndex[i].savings=this.ruleIndex[i].offset-this.ruleIndex[i-1].offset}}if(!this.transitionTimes.length){this.standardTime=this.zoneInfo[0]}else{for(var j=tzh_timecnt-1;j>-1;j--){var tti=this.ruleIndex[j];if(!this.standardTime&&!tti.isdst){this.standardTime=tti}else if(!this.daylightTime&&tti.isdst){this.daylightTime=tti}if(this.daylightTime&&this.standardTime)break}if(this.daylightTime&&!this.standardTime){this.standardTime=this.daylightTime}for(var k=this.zoneInfo.length-1;k>0;k--){if(!this.zoneInfo[k].isdst){this.defaultTime=this.zoneInfo[k];break}}}if(!this.defaultTime){this.defaultTime=this.zoneInfo[this.zoneInfo.length-1]}}};ZoneInfoFile.prototype.bsearch=function(target,arr){if(typeof arr==="undefined"||!arr||typeof target==="undefined"||target<arr[0]){return-1}if(target>arr[arr.length-1]){return arr.length-1}var high=arr.length-1,low=0,mid=0,value;while(low<=high){mid=Math.floor((high+low)/2);value=arr[mid]-target;if(value>0){high=mid-1}else if(value<0){low=mid+1}else{return mid}}return high};ZoneInfoFile.prototype.usesDST=function(date){var thisYear=date.getTime();var nextYear=thisYear+31536e6;var index=this.bsearch(thisYear,this.transitionTimes);if(index!==-1){while(index<this.transitionTimes.length&&this.transitionTimes[index]<nextYear){if(this.ruleIndex[index++].isdst){return true}}}return false};ZoneInfoFile.prototype.getRawOffset=function(date){var thisYear=date.getTime();var nextYear=thisYear+31536e6;var index=this.bsearch(thisYear,this.transitionTimes);var offset=this.defaultTime.offset;if(index>-1){while(index<this.transitionTimes.length&&this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst){offset=this.ruleIndex[index].offset}}return offset};ZoneInfoFile.prototype.getDSTSavings=function(date){var thisYear=date.getTime();var nextYear=thisYear+31536e6;var index=this.bsearch(thisYear,this.transitionTimes);var savings=0;if(index>-1){while(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&this.ruleIndex[index].isdst){savings=this.ruleIndex[index].savings}}return savings};ZoneInfoFile.prototype.getDSTStartDate=function(date){var year=date.getFullYear();var thisYear=new Date(year,0,1).getTime();var nextYear=new Date(year+1,0,1).getTime();var index=this.bsearch(thisYear,this.transitionTimes);var startDate=-1;if(index>-1){if(this.transitionTimes[index]<thisYear){index++}while(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&this.ruleIndex[index].isdst){startDate=this.transitionTimes[index]}}return startDate};ZoneInfoFile.prototype.getDSTEndDate=function(date){var year=date.getFullYear();var thisYear=new Date(year,0,1).getTime();var nextYear=new Date(year+1,0,1).getTime();var index=this.bsearch(thisYear,this.transitionTimes);var endDate=-1;if(index>-1){if(this.transitionTimes[index]<thisYear){index++}while(index<this.transitionTimes.length&&this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst){endDate=this.transitionTimes[index]}}return endDate};ZoneInfoFile.prototype.getAbbreviation=function(date){var thisYear=date.getTime();var nextYear=thisYear+31536e6;var abbr;if(this.transitionTimes.length>0){var index=this.bsearch(thisYear,this.transitionTimes);abbr=this.ruleIndex[index].abbreviation;if(index>-1){while(index<this.transitionTimes.length&&this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst){abbr=this.ruleIndex[index].abbreviation}}}else{abbr=this.standardTime.abbreviation}return abbr};ZoneInfoFile.prototype.getDSTAbbreviation=function(date){var thisYear=date.getTime();var nextYear=thisYear+31536e6;var abbr;if(this.transitionTimes.length>0){var index=this.bsearch(thisYear,this.transitionTimes);abbr=this.ruleIndex[index].abbreviation;if(index>-1){while(index<this.transitionTimes.length&&!this.ruleIndex[index].isdst&&this.transitionTimes[index+1]<nextYear){index++}if(index<this.transitionTimes.length&&this.ruleIndex[index].isdst){abbr=this.ruleIndex[index].abbreviation}}}else{abbr=this.standardTime.abbreviation}return abbr};ZoneInfoFile.prototype.getIlibZoneInfo=function(date){function minutesToStr(min){var hours=Math.floor(min/60);var minutes=min-hours*60;return hours+":"+minutes}function unixtimeToJD(millis){return 2440587.5+millis/864e5}var res={o:minutesToStr(this.getRawOffset(date))};if(this.usesDST(date)){res.f="{c}";res.e={c:this.getAbbreviation(date),j:unixtimeToJD(this.getDSTEndDate(date))};res.s={c:this.getDSTAbbreviation(date),j:unixtimeToJD(this.getDSTStartDate(date)),v:minutesToStr(this.getDSTSavings(date))}}else{res.f=this.getAbbreviation(date)}return res};module.exports=ZoneInfoFile;