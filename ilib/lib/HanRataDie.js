var ilib=require("./ilib.js");var MathUtils=require("./MathUtils.js");var HanCal=require("./HanCal.js");var RataDie=require("./RataDie.js");var HanRataDie=function(params){this.rd=undefined;if(params&&params.cal){this.cal=params.cal;RataDie.call(this,params);if(params&&typeof params.callback==="function"){params.callback(this)}}else{new HanCal({sync:params&&params.sync,loadParams:params&&params.loadParams,callback:ilib.bind(this,function(c){this.cal=c;RataDie.call(this,params);if(params&&typeof params.callback==="function"){params.callback(this)}})})}};HanRataDie.prototype=new RataDie();HanRataDie.prototype.parent=RataDie;HanRataDie.prototype.constructor=HanRataDie;HanRataDie.epoch=758325.5;HanRataDie.prototype._setDateComponents=function(date){var calc=HanCal._leapYearCalc(date.year,date.cycle);var m2=HanCal._newMoonOnOrAfter(calc.m1+1);var newYears;this.leapYear=Math.round((calc.m2-calc.m1)/29.530588853)===12;if(this.leapYear&&(HanCal._noMajorST(calc.m1)||HanCal._noMajorST(m2))){newYears=HanCal._newMoonOnOrAfter(m2+1)}else{newYears=m2}var priorNewMoon=HanCal._newMoonOnOrAfter(calc.m1+date.month*29);this.priorLeapMonth=HanRataDie._priorLeapMonth(newYears,HanCal._newMoonBefore(priorNewMoon));this.leapMonth=this.leapYear&&HanCal._noMajorST(priorNewMoon)&&!this.priorLeapMonth;var rdtime=(date.hour*36e5+date.minute*6e4+date.second*1e3+date.millisecond)/864e5;this.rd=priorNewMoon+date.day-1+rdtime-RataDie.gregorianEpoch};HanRataDie.prototype._onOrBefore=function(rd,dayOfWeek){return rd-MathUtils.mod(Math.floor(rd)-dayOfWeek,7)};HanRataDie._priorLeapMonth=function(jd1,jd2){return jd2>=jd1&&(HanRataDie._priorLeapMonth(jd1,HanCal._newMoonBefore(jd2))||HanCal._noMajorST(jd2))};module.exports=HanRataDie;