var ilib=require("./ilib.js");var MathUtils=require("./MathUtils.js");var Astro=require("./Astro.js");var RataDie=require("./RataDie.js");var GregorianDate=require("./GregorianDate.js");var PersRataDie=function(params){this.rd=undefined;Astro.initAstro(params&&typeof params.sync==="boolean"?params.sync:true,params&&params.loadParams,ilib.bind(this,function(x){RataDie.call(this,params);if(params&&typeof params.callback==="function"){params.callback(this)}}))};PersRataDie.prototype=new RataDie();PersRataDie.prototype.parent=RataDie;PersRataDie.prototype.constructor=PersRataDie;PersRataDie.prototype.epoch=1948319.5;PersRataDie.prototype._tehranEquinox=function(year){var equJED,equJD,equAPP,equTehran,dtTehran,eot;equJED=Astro._equinox(year,0);equJD=equJED-Astro._deltat(year)/(24*60*60);eot=Astro._equationOfTime(equJED)*360;eot=(eot-20*Math.floor(eot/20))/360;equAPP=equJD+eot;dtTehran=52.5/360;equTehran=equAPP+dtTehran;return equTehran};PersRataDie.prototype._getYear=function(jd){var gd=new GregorianDate({julianday:jd});var guess=gd.getYears()-2,nexteq,ret={};ret.equinox=this._tehranEquinox(guess);while(ret.equinox>jd){guess--;ret.equinox=this._tehranEquinox(guess)}nexteq=ret.equinox-1;while(!(Math.floor(ret.equinox)+.5<=jd&&jd<Math.floor(nexteq)+.5)){ret.equinox=nexteq;guess++;nexteq=this._tehranEquinox(guess)}ret.year=Math.round((ret.equinox-this.epoch-1)/365.24219878)+1;return ret};PersRataDie.prototype._setDateComponents=function(date){var adr,guess,jd;guess=this.epoch+1+365.24219878*(date.year-2);adr={year:date.year-1,equinox:0};while(adr.year<date.year){adr=this._getYear(guess);guess=adr.equinox+(365.24219878+2)}jd=Math.floor(adr.equinox)+(date.month<=7?(date.month-1)*31:(date.month-1)*30+6)+(date.day-1+.5);jd+=(date.hour*36e5+date.minute*6e4+date.second*1e3+date.millisecond)/864e5;this.rd=jd-this.epoch};PersRataDie.prototype._onOrBefore=function(rd,dayOfWeek){return rd-MathUtils.mod(Math.floor(rd)-dayOfWeek-3,7)};module.exports=PersRataDie;