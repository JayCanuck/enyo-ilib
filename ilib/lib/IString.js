var ilib=require("./ilib.js");var Utils=require("./Utils.js");var MathUtils=require("./MathUtils.js");var Locale=require("./Locale.js");var IString=function(string){if(typeof string==="object"){if(string instanceof IString){this.str=string.str}else{this.str=string.toString()}}else if(typeof string==="string"){this.str=new String(string)}else{this.str=""}this.length=this.str.length;this.cpLength=-1;this.localeSpec=ilib.getLocale()};IString._isSurrogate=function(ch){var n=ch.charCodeAt(0);return n>=56320&&n<=57343||n>=55296&&n<=56319};IString.fromCodePoint=function(codepoint){if(codepoint<65536){return String.fromCharCode(codepoint)}else{var high=Math.floor(codepoint/65536)-1;var low=codepoint&65535;return String.fromCharCode(55296|(high&15)<<6|(low&64512)>>10)+String.fromCharCode(56320|low&1023)}};IString.toCodePoint=function(str,index){if(!str||str.length===0){return-1}var code=-1,high=str.charCodeAt(index);if(high>=55296&&high<=56319){if(str.length>index+1){var low=str.charCodeAt(index+1);if(low>=56320&&low<=57343){code=((high&960)>>6)+1<<16|((high&63)<<10|low&1023)}}}else{code=high}return code};IString.loadPlurals=function(sync,locale,loadParams,onLoad){var loc;if(locale){loc=typeof locale==="string"?new Locale(locale):locale}else{loc=new Locale(ilib.getLocale())}var spec=loc.getLanguage();if(!ilib.data["plurals_"+spec]){Utils.loadData({name:"plurals.json",object:IString,locale:loc,sync:sync,loadParams:loadParams,callback:ilib.bind(this,function(plurals){if(!plurals){IString.cache[spec]={}}ilib.data["plurals_"+spec]=plurals||{};if(onLoad&&typeof onLoad==="function"){onLoad(ilib.data["plurals_"+spec])}})})}else{if(onLoad&&typeof onLoad==="function"){onLoad(ilib.data["plurals_"+spec])}}};IString._fncs={firstProp:function(obj){for(var p in obj){if(p&&obj[p]){return p}}return undefined},getValue:function(obj,n){if(typeof obj==="object"){var subrule=IString._fncs.firstProp(obj);return IString._fncs[subrule](obj[subrule],n)}else if(typeof obj==="string"){return n}else{return obj}},matchRangeContinuous:function(n,range){for(var num in range){if(typeof num!=="undefined"&&typeof range[num]!=="undefined"){var obj=range[num];if(typeof obj==="number"){if(n===range[num]){return true}}else if(Object.prototype.toString.call(obj)==="[object Array]"){if(n>=obj[0]&&n<=obj[1]){return true}}}}return false},matchRange:function(n,range){if(Math.floor(n)!==n){return false}return IString._fncs.matchRangeContinuous(n,range)},is:function(rule,n){var left=IString._fncs.getValue(rule[0],n);var right=IString._fncs.getValue(rule[1],n);return left==right},isnot:function(rule,n){return IString._fncs.getValue(rule[0],n)!=IString._fncs.getValue(rule[1],n)},inrange:function(rule,n){return IString._fncs.matchRange(IString._fncs.getValue(rule[0],n),rule[1])},notin:function(rule,n){return!IString._fncs.matchRange(IString._fncs.getValue(rule[0],n),rule[1])},within:function(rule,n){return IString._fncs.matchRangeContinuous(IString._fncs.getValue(rule[0],n),rule[1])},mod:function(rule,n){return MathUtils.mod(IString._fncs.getValue(rule[0],n),IString._fncs.getValue(rule[1],n))},n:function(rule,n){return n},or:function(rule,n){return IString._fncs.getValue(rule[0],n)||IString._fncs.getValue(rule[1],n)},and:function(rule,n){return IString._fncs.getValue(rule[0],n)&&IString._fncs.getValue(rule[1],n)}};IString.prototype={_length:function(){return this.str.length},format:function(params){var formatted=this.str;if(params){var regex;for(var p in params){if(typeof params[p]!=="undefined"){regex=new RegExp("{"+p+"}","g");formatted=formatted.replace(regex,params[p])}}}return formatted.toString()},formatChoice:function(argIndex,params){var choices=this.str.split("|");var type=typeof argIndex;var limits=[];var strings=[];var i;var parts;var limit;var arg;var result=undefined;var defaultCase="";if(this.str.length===0){return""}for(i=0;i<choices.length;i++){parts=choices[i].split("#");if(parts.length>2){limits[i]=parts[0];parts=parts.shift();strings[i]=parts.join("#")}else if(parts.length===2){limits[i]=parts[0];strings[i]=parts[1]}else{throw"syntax error in choice format pattern: "+choices[i]}}for(i=0;i<limits.length;i++){if(limits[i].length===0){defaultCase=new IString(strings[i])}else{switch(type){case"number":arg=parseInt(argIndex,10);if(limits[i].substring(0,2)==="<="){limit=parseFloat(limits[i].substring(2));if(arg<=limit){result=new IString(strings[i]);i=limits.length}}else if(limits[i].substring(0,2)===">="){limit=parseFloat(limits[i].substring(2));if(arg>=limit){result=new IString(strings[i]);i=limits.length}}else if(limits[i].charAt(0)==="<"){limit=parseFloat(limits[i].substring(1));if(arg<limit){result=new IString(strings[i]);i=limits.length}}else if(limits[i].charAt(0)===">"){limit=parseFloat(limits[i].substring(1));if(arg>limit){result=new IString(strings[i]);i=limits.length}}else{this.locale=this.locale||new Locale(this.localeSpec);switch(limits[i]){case"zero":case"one":case"two":case"few":case"many":var ruleset=ilib.data["plurals_"+this.locale.getLanguage()];if(ruleset){var rule=ruleset[limits[i]];if(IString._fncs.getValue(rule,arg)){result=new IString(strings[i]);i=limits.length}}break;default:var dash=limits[i].indexOf("-");if(dash!==-1){var start=limits[i].substring(0,dash);var end=limits[i].substring(dash+1);if(arg>=parseInt(start,10)&&arg<=parseInt(end,10)){result=new IString(strings[i]);i=limits.length}}else if(arg===parseInt(limits[i],10)){result=new IString(strings[i]);i=limits.length}break}}break;case"boolean":if(limits[i]==="true"&&argIndex===true){result=new IString(strings[i]);i=limits.length}else if(limits[i]==="false"&&argIndex===false){result=new IString(strings[i]);i=limits.length}break;case"string":var regexp=new RegExp(limits[i],"i");if(regexp.test(argIndex)){result=new IString(strings[i]);i=limits.length}break;case"object":throw"syntax error: fmtChoice parameter for the argument index cannot be an object"}}}if(!result){result=defaultCase||new IString("")}result=result.format(params);return result.toString()},toString:function(){return this.str.toString()},valueOf:function(){return this.str.valueOf()},charAt:function(index){return new IString(this.str.charAt(index))},charCodeAt:function(index){return this.str.charCodeAt(index)},concat:function(strings){return new IString(this.str.concat(strings))},indexOf:function(searchValue,start){return this.str.indexOf(searchValue,start)},lastIndexOf:function(searchValue,start){return this.str.lastIndexOf(searchValue,start)},match:function(regexp){return this.str.match(regexp)},replace:function(searchValue,newValue){return new IString(this.str.replace(searchValue,newValue))},search:function(regexp){return this.str.search(regexp)},slice:function(start,end){return new IString(this.str.slice(start,end))},split:function(separator,limit){return this.str.split(separator,limit)},substr:function(start,length){var plat=ilib._getPlatform();if(plat==="qt"||plat==="rhino"||plat==="trireme"){if(typeof length==="undefined"){length=this.str.length-start}}return new IString(this.str.substr(start,length))},substring:function(from,to){return this.str.substring(from,to)},toLowerCase:function(){return this.str.toLowerCase()},toUpperCase:function(){return this.str.toUpperCase()},_toCodePoint:function(index){return IString.toCodePoint(this.str,index)},forEach:function(callback){if(typeof callback==="function"){var it=this.charIterator();while(it.hasNext()){callback(it.next())}}},forEachCodePoint:function(callback){if(typeof callback==="function"){var it=this.iterator();while(it.hasNext()){callback(it.next())}}},iterator:function(){function _iterator(istring){this.index=0;this.hasNext=function(){return this.index<istring.str.length};this.next=function(){if(this.index<istring.str.length){var num=istring._toCodePoint(this.index);this.index+=num>65535?2:1}else{num=-1}return num}}return new _iterator(this)},charIterator:function(){function _chiterator(istring){this.index=0;this.hasNext=function(){return this.index<istring.str.length};this.next=function(){var ch;if(this.index<istring.str.length){ch=istring.str.charAt(this.index);if(IString._isSurrogate(ch)&&this.index+1<istring.str.length&&IString._isSurrogate(istring.str.charAt(this.index+1))){this.index++;ch+=istring.str.charAt(this.index)}this.index++}return ch}}return new _chiterator(this)},codePointAt:function(index){if(index<0){return-1}var count,it=this.iterator(),ch;for(count=index;count>=0&&it.hasNext();count--){ch=it.next()}return count<0?ch:-1},setLocale:function(locale,sync,loadParams,onLoad){if(typeof locale==="object"){this.locale=locale}else{this.localeSpec=locale;this.locale=new Locale(locale)}IString.loadPlurals(typeof sync!=="undefined"?sync:true,this.locale,loadParams,onLoad)},getLocale:function(){return(this.locale?this.locale.getSpec():this.localeSpec)||ilib.getLocale()},codePointLength:function(){if(this.cpLength===-1){var it=this.iterator();this.cpLength=0;while(it.hasNext()){this.cpLength++;it.next()}}return this.cpLength}};module.exports=IString;