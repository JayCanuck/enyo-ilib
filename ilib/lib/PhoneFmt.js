var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var Locale=require("./Locale.js");var PhoneNumber=require("./PhoneNumber.js");var NumberingPlan=require("./NumberingPlan.js");var PhoneLocale=require("./PhoneLocale.js");var PhoneFmt=function(options){this.sync=true;this.styleName="default",this.loadParams={};var locale=new Locale();if(options){if(options.locale){locale=options.locale}if(typeof options.sync!=="undefined"){this.sync=options.sync==true}if(options.loadParams){this.loadParams=options.loadParams}if(options.style){this.style=options.style}}new PhoneLocale({locale:locale,mcc:options&&options.mcc,countryCode:options&&options.countryCode,onLoad:ilib.bind(this,function(data){this.locale=data;new NumberingPlan({locale:this.locale,sync:this.sync,loadParms:this.loadParams,onLoad:ilib.bind(this,function(plan){this.plan=plan;Utils.loadData({name:"phonefmt.json",object:PhoneFmt,locale:this.locale,sync:this.sync,loadParams:JSUtils.merge(this.loadParams,{returnOne:true}),callback:ilib.bind(this,function(fmtdata){this.fmtdata=fmtdata;if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})})})})})})};PhoneFmt.prototype={_substituteDigits:function(part,formats,mustUseAll){var formatString,formatted="",partIndex=0,templates,i;if(!part){return formatted}if(typeof formats==="object"){templates=typeof formats.template!=="undefined"?formats.template:formats;if(part.length>templates.length){throw"part "+part+" is too big. We do not have a format template to format it."}formatString=templates[part.length-1]}else{formatString=formats}for(i=0;i<formatString.length;i++){if(formatString.charAt(i)==="X"){formatted+=part.charAt(partIndex);partIndex++}else{formatted+=formatString.charAt(i)}}if(mustUseAll&&partIndex<part.length-1){throw"too many digits in "+part+" for format "+formatString}return formatted},_getStyle:function(name,fmtdata){return fmtdata[name]||fmtdata["default"]},_doFormat:function(number,options,startField,locale,fmtdata,callback){var sync=true,loadParams={},temp,templates,fieldName,countryCode,isWhole,style,formatted="",styleTemplates,lastFieldName;if(options){if(typeof options.sync!=="undefined"){sync=options.sync==true}if(options.loadParams){loadParams=options.loadParams}}style=this.style;if(number.countryCode){style=number.mobilePrefix?"internationalmobile":"international"}else if(number.mobilePrefix!==undefined){style="mobile"}else if(number.serviceCode!==undefined&&typeof fmtdata["service"]!=="undefined"){style="service"}isWhole=!options||!options.partial;styleTemplates=this._getStyle(style,fmtdata);styleTemplates=(isWhole?styleTemplates.whole:styleTemplates.partial)||styleTemplates;for(var i=startField;i<PhoneNumber._fieldOrder.length;i++){fieldName=PhoneNumber._fieldOrder[i];if(number[fieldName]!==undefined){if(styleTemplates[fieldName]!==undefined){templates=styleTemplates[fieldName];if(fieldName==="trunkAccess"){if(number.areaCode===undefined&&number.serviceCode===undefined&&number.mobilePrefix===undefined){templates="X"}}if(lastFieldName&&typeof styleTemplates[lastFieldName].suffix!=="undefined"){if(fieldName!=="extension"&&number[fieldName].search(/[xwtp,;]/i)<=-1){formatted+=styleTemplates[lastFieldName].suffix}}lastFieldName=fieldName;temp=this._substituteDigits(number[fieldName],templates,fieldName==="subscriberNumber");formatted+=temp;if(fieldName==="countryCode"){countryCode=number.countryCode.replace(/[wWpPtT\+#\*]/g,"");new PhoneLocale({locale:this.locale,sync:sync,loadParms:loadParams,countryCode:countryCode,onLoad:ilib.bind(this,function(locale){Utils.loadData({name:"phonefmt.json",object:PhoneFmt,locale:locale,sync:sync,loadParams:JSUtils.merge(loadParams,{returnOne:true}),callback:ilib.bind(this,function(fmtdata){var subfmt="";this._doFormat(number,options,i+1,locale,fmtdata,function(subformat){subfmt=subformat;if(typeof callback==="function"){callback(formatted+subformat)}});formatted+=subfmt})})})});return formatted}}else{formatted+=number[fieldName]}}}if(typeof callback==="function"){callback(formatted)}return formatted},format:function(number,options){var formatted="",callback;callback=options&&options.onLoad;try{this._doFormat(number,options,0,this.locale,this.fmtdata,function(fmt){formatted=fmt;if(typeof callback==="function"){callback(fmt)}})}catch(e){if(typeof e==="string"){formatted="";for(var field in PhoneNumber._fieldOrder){if(typeof field==="string"&&typeof PhoneNumber._fieldOrder[field]==="string"&&number[PhoneNumber._fieldOrder[field]]!==undefined){formatted+=number[PhoneNumber._fieldOrder[field]];if(PhoneNumber._fieldOrder[field]==="countryCode"){formatted+=" "}}}}else{throw e}if(typeof callback==="function"){callback(formatted)}}return formatted},getAvailableStyles:function(){var ret=[],style;if(this.fmtdata){for(style in this.fmtdata){if(this.fmtdata[style].example){ret.push(style)}}}return ret},getStyleExample:function(style){return this.fmtdata[style].example||undefined}};module.exports=PhoneFmt;