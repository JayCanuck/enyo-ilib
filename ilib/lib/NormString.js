var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var IString=require("./IString.js");var GlyphString=require("./GlyphString.js");var NormString=function(str){GlyphString.call(this,str)};NormString.prototype=new GlyphString("",{noinstance:true});NormString.prototype.parent=GlyphString;NormString.prototype.constructor=NormString;NormString.init=function(options){if(!ilib._load||typeof ilib._load!=="function"&&typeof ilib._load.loadFiles!=="function"){return}var form="nfkc";var script="all";var sync=true;var onLoad=undefined;var loadParams=undefined;if(options){form=options.form||"nfkc";script=options.script||"all";sync=typeof options.sync!=="undefined"?options.sync:true;onLoad=typeof options.onLoad==="function"?options.onLoad:undefined;if(options.loadParams){loadParams=options.loadParams}}var formDependencies={nfd:["nfd"],nfc:["nfd"],nfkd:["nfkd","nfd"],nfkc:["nfkd","nfd"]};var files=["normdata.json"];var forms=formDependencies[form];for(var f in forms){files.push(forms[f]+"/"+script+".json")}if(JSUtils.isEmpty(ilib.data.norm.ccc)||JSUtils.isEmpty(ilib.data.norm.nfd)||JSUtils.isEmpty(ilib.data.norm.nfkd)){Utils._callLoadData(files,sync,loadParams,function(arr){ilib.extend(ilib.data.norm,arr[0]);for(var i=1;i<arr.length;i++){if(typeof arr[i]!=="undefined"){ilib.extend(ilib.data.norm[forms[i-1]],arr[i])}}if(onLoad){onLoad(arr)}})}};NormString._decomposeHangul=function(cp){var sindex=cp-44032;var result=String.fromCharCode(4352+sindex/588)+String.fromCharCode(4449+sindex%588/28);var t=sindex%28;if(t!==0){result+=String.fromCharCode(4519+t)}return result};NormString._expand=function(ch,canon,compat){var i,expansion="",n=ch.charCodeAt(0);if(GlyphString._isHangul(n)){expansion=NormString._decomposeHangul(n)}else{var result=canon[ch];if(!result&&compat){result=compat[ch]}if(result&&result!==ch){for(i=0;i<result.length;i++){expansion+=NormString._expand(result[i],canon,compat)}}else{expansion=ch}}return expansion};NormString.prototype.normalize=function(form){var i;if(typeof form!=="string"||this.str.length===0){return new IString(this.str)}var nfc=false,nfkd=false;switch(form){default:break;case"nfc":nfc=true;break;case"nfkd":nfkd=true;break;case"nfkc":nfkd=true;nfc=true;break}var decomp="";if(nfkd){var ch,it=IString.prototype.charIterator.call(this);while(it.hasNext()){ch=it.next();decomp+=NormString._expand(ch,ilib.data.norm.nfd,ilib.data.norm.nfkd)}}else{var ch,it=IString.prototype.charIterator.call(this);while(it.hasNext()){ch=it.next();decomp+=NormString._expand(ch,ilib.data.norm.nfd)}}function compareByCCC(left,right){return ilib.data.norm.ccc[left]-ilib.data.norm.ccc[right]}function ccc(c){return ilib.data.norm.ccc[c]||0}function sortChars(arr,comp){if(ilib._getPlatform()==="qt"){var tmp;for(var i=arr.length-1;i>0;i--){for(var j=0;j<i;j++){if(comp(arr[j],arr[j+1])>0){tmp=arr[j];arr[j]=arr[j+1];arr[j+1]=tmp}}}return arr}else{return arr.sort(comp)}}var dstr=new IString(decomp);var it=dstr.charIterator();var cpArray=[];while(it.hasNext()){cpArray.push(it.next())}i=0;while(i<cpArray.length){if(typeof ilib.data.norm.ccc[cpArray[i]]!=="undefined"&&ccc(cpArray[i])!==0){var end=i+1;while(end<cpArray.length&&typeof ilib.data.norm.ccc[cpArray[end]]!=="undefined"&&ccc(cpArray[end])!==0){end++}if(end-i>1){cpArray=cpArray.slice(0,i).concat(sortChars(cpArray.slice(i,end),compareByCCC),cpArray.slice(end))}}i++}if(nfc){i=0;while(i<cpArray.length){if(typeof ilib.data.norm.ccc[cpArray[i]]==="undefined"||ilib.data.norm.ccc[cpArray[i]]===0){var end=i+1;var notdone=true;while(end<cpArray.length&&notdone){if(typeof ilib.data.norm.ccc[cpArray[end]]!=="undefined"&&ilib.data.norm.ccc[cpArray[end]]!==0){if(ccc(cpArray[end-1])<ccc(cpArray[end])){var testChar=GlyphString._compose(cpArray[i],cpArray[end]);if(typeof testChar!=="undefined"){cpArray[i]=testChar;cpArray.splice(end,1);end=i}}end++}else{var testChar=GlyphString._compose(cpArray[i],cpArray[end]);if(ccc(cpArray[end-1])===0&&typeof testChar!=="undefined"){cpArray[i]=testChar;cpArray.splice(end,1);end=i+1}else{notdone=false}}}}i++}}return new IString(cpArray.length>0?cpArray.join(""):"")};NormString.prototype.charIterator=function(){var it=IString.prototype.charIterator.call(this);function _chiterator(istring){var ccc=function(c){return ilib.data.norm.ccc[c]||0};this.index=0;this.hasNext=function(){return!!this.nextChar||it.hasNext()};this.next=function(){var ch=this.nextChar||it.next(),prevCcc=ccc(ch),nextCcc,composed=ch;this.nextChar=undefined;if(ilib.data.norm.ccc&&(typeof ilib.data.norm.ccc[ch]==="undefined"||ccc(ch)===0)){var notdone=true;while(it.hasNext()&&notdone){this.nextChar=it.next();nextCcc=ccc(this.nextChar);if(typeof ilib.data.norm.ccc[this.nextChar]!=="undefined"&&nextCcc!==0){ch+=this.nextChar;this.nextChar=undefined}else{var testChar=GlyphString._compose(composed,this.nextChar);if(prevCcc===0&&typeof testChar!=="undefined"){composed=testChar;ch+=this.nextChar;this.nextChar=undefined}else{notdone=false}}prevCcc=nextCcc}}return ch}}return new _chiterator(this)};module.exports=NormString;