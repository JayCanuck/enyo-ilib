var ilib=require("./ilib.js");var SearchUtils=require("./SearchUtils.js");var MathUtils=require("./MathUtils.js");var Locale=require("./Locale.js");var LocaleInfo=require("./LocaleInfo.js");var JulianDay=require("./JulianDay.js");var IDate=require("./IDate.js");var TimeZone=require("./TimeZone.js");var Calendar=require("./Calendar.js");var GregorianCal=require("./GregorianCal.js");var GregRataDie=require("./GregRataDie.js");var GregorianDate=function(params){this.cal=new GregorianCal();this.timezone="local";if(params){if(typeof params.noinstance==="boolean"&&params.noinstance){return}if(params.locale){this.locale=typeof params.locale==="string"?new Locale(params.locale):params.locale;var li=new LocaleInfo(this.locale);this.timezone=li.getTimeZone()}if(params.timezone){this.timezone=params.timezone.toString()}if(params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond){this.year=parseInt(params.year,10)||0;this.month=parseInt(params.month,10)||1;this.day=parseInt(params.day,10)||1;this.hour=parseInt(params.hour,10)||0;this.minute=parseInt(params.minute,10)||0;this.second=parseInt(params.second,10)||0;this.millisecond=parseInt(params.millisecond,10)||0;if(typeof params.dst==="boolean"){this.dst=params.dst}this.rd=this.newRd(params);this.offset=0;if(this.timezone==="local"&&typeof params.dst==="undefined"){var d=new Date(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);this.offset=-d.getTimezoneOffset()/1440}else{if(!this.tz){this.tz=new TimeZone({id:this.timezone})}this.offset=this.tz._getOffsetMillisWallTime(this)/864e5}if(this.offset!==0){this.rd=this.newRd({rd:this.rd.getRataDie()-this.offset})}}}if(!this.rd){this.rd=this.newRd(params);this._calcDateComponents()}};GregorianDate.prototype=new IDate({noinstance:true});GregorianDate.prototype.parent=IDate;GregorianDate.prototype.constructor=GregorianDate;GregorianDate.prototype.newRd=function(params){return new GregRataDie(params)};GregorianDate._calcYear=function(rd){var days400,days100,days4,years400,years100,years4,years1,year;years400=Math.floor((rd-1)/146097);days400=MathUtils.mod(rd-1,146097);years100=Math.floor(days400/36524);days100=MathUtils.mod(days400,36524);years4=Math.floor(days100/1461);days4=MathUtils.mod(days100,1461);years1=Math.floor(days4/365);year=400*years400+100*years100+4*years4+years1;if(years100!==4&&years1!==4){year++}return year};GregorianDate.prototype._calcYear=function(rd){return GregorianDate._calcYear(rd)};GregorianDate.prototype._calcDateComponents=function(){if(this.timezone==="local"&&this.rd.getRataDie()>=-99280837&&this.rd.getRataDie()<=100719163){var d=new Date(this.rd.getTimeExtended());this.year=d.getFullYear();this.month=d.getMonth()+1;this.day=d.getDate();this.hour=d.getHours();this.minute=d.getMinutes();this.second=d.getSeconds();this.millisecond=d.getMilliseconds();this.offset=-d.getTimezoneOffset()/1440}else{if(typeof this.offset==="undefined"){this.year=this._calcYear(this.rd.getRataDie());if(!this.tz){this.tz=new TimeZone({id:this.timezone})}this.offset=this.tz.getOffsetMillis(this)/864e5}var rd=this.rd.getRataDie();if(this.offset!==0){rd+=this.offset}this.year=this._calcYear(rd);var yearStartRd=this.newRd({year:this.year,month:1,day:1,cal:this.cal});var remainder=rd-yearStartRd.getRataDie()+1;var cumulative=GregorianCal.prototype.isLeapYear.call(this.cal,this.year)?GregRataDie.cumMonthLengthsLeap:GregRataDie.cumMonthLengths;this.month=SearchUtils.bsearch(Math.floor(remainder),cumulative);remainder=remainder-cumulative[this.month-1];this.day=Math.floor(remainder);remainder-=this.day;remainder=Math.round(remainder*864e5);this.hour=Math.floor(remainder/36e5);remainder-=this.hour*36e5;this.minute=Math.floor(remainder/6e4);remainder-=this.minute*6e4;this.second=Math.floor(remainder/1e3);remainder-=this.second*1e3;this.millisecond=Math.floor(remainder)}};GregorianDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.rd.getRataDie()+(this.offset||0));return MathUtils.mod(rd,7)};GregorianDate.prototype.getDayOfYear=function(){var cumulativeMap=this.cal.isLeapYear(this.year)?GregRataDie.cumMonthLengthsLeap:GregRataDie.cumMonthLengths;return cumulativeMap[this.month-1]+this.day};GregorianDate.prototype.getEra=function(){return this.year<1?-1:1};GregorianDate.prototype.getCalendar=function(){return"gregorian"};IDate._constructors["gregorian"]=GregorianDate;module.exports=GregorianDate;