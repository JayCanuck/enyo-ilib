var ilib=require("./ilib.js");var JSUtils=require("./JSUtils.js");var MathUtils=require("./MathUtils.js");var Locale=require("./Locale.js");var LocaleInfo=require("./LocaleInfo.js");var IDate=require("./IDate.js");var TimeZone=require("./TimeZone.js");var Calendar=require("./Calendar.js");var Astro=require("./Astro.js");var HanCal=require("./HanCal.js");var GregorianDate=require("./GregorianDate.js");var HanRataDie=require("./HanRataDie.js");var RataDie=require("./RataDie.js");var HanDate=function(params){this.timezone="local";if(params){if(params.locale){this.locale=typeof params.locale==="string"?new Locale(params.locale):params.locale;var li=new LocaleInfo(this.locale);this.timezone=li.getTimeZone()}if(params.timezone){this.timezone=params.timezone}}new HanCal({sync:params&&typeof params==="boolean"?params.sync:true,loadParams:params&&params.loadParams,callback:ilib.bind(this,function(cal){this.cal=cal;if(params&&(params.year||params.month||params.day||params.hour||params.minute||params.second||params.millisecond||params.cycle||params.cycleYear)){if(typeof params.cycle!=="undefined"){this.cycle=parseInt(params.cycle,10)||0;var year=(typeof params.year!=="undefined"?parseInt(params.year,10):parseInt(params.cycleYear,10))||0;this.year=HanCal._getElapsedYear(year,this.cycle)}else{if(typeof params.year!=="undefined"){this.year=parseInt(params.year,10)||0;this.cycle=Math.floor((this.year-1)/60)}else{this.year=this.cycle=0}}this.month=parseInt(params.month,10)||1;this.day=parseInt(params.day,10)||1;this.hour=parseInt(params.hour,10)||0;this.minute=parseInt(params.minute,10)||0;this.second=parseInt(params.second,10)||0;this.millisecond=parseInt(params.millisecond,10)||0;this.cycleYear=MathUtils.amod(this.year,60);this.dayOfYear=parseInt(params.dayOfYear,10);if(typeof params.dst==="boolean"){this.dst=params.dst}this.newRd({cal:this.cal,cycle:this.cycle,year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second,millisecond:this.millisecond,sync:params&&typeof params.sync==="boolean"?params.sync:true,loadParams:params&&params.loadParams,callback:ilib.bind(this,function(rd){if(rd){this.rd=rd;if(!this.tz){this.tz=new TimeZone({id:this.timezone})}this.offset=this.tz._getOffsetMillisWallTime(this)/864e5;if(this.offset!==0){this.rd=this.newRd({cal:this.cal,rd:this.rd.getRataDie()-this.offset});this._calcLeap()}else{this.leapMonth=this.rd.leapMonth;this.priorLeapMonth=this.rd.priorLeapMonth;this.leapYear=this.rd.leapYear}}if(!this.rd){this.rd=this.newRd(JSUtils.merge(params||{},{cal:this.cal}));this._calcDateComponents()}if(params&&typeof params.onLoad==="function"){params.onLoad(this)}})})}else{if(!this.rd){this.rd=this.newRd(JSUtils.merge(params||{},{cal:this.cal}));this._calcDateComponents()}if(params&&typeof params.onLoad==="function"){params.onLoad(this)}}})})};HanDate.prototype=new IDate({noinstance:true});HanDate.prototype.parent=IDate;HanDate.prototype.constructor=HanDate;HanDate.prototype.newRd=function(params){return new HanRataDie(params)};HanDate.prototype._calcYear=function(rd){var gregdate=new GregorianDate({rd:rd,timezone:this.timezone});var hanyear=gregdate.year+2697;var newYears=this.cal.newYears(hanyear);return hanyear-(rd+RataDie.gregorianEpoch<newYears?1:0)};HanDate.prototype._calcLeap=function(){var jd=this.rd.getRataDie()+RataDie.gregorianEpoch;var calc=HanCal._leapYearCalc(this.year);var m2=HanCal._newMoonOnOrAfter(calc.m1+1);this.leapYear=Math.round((calc.m2-calc.m1)/29.530588853)===12;var newYears=this.leapYear&&(HanCal._noMajorST(calc.m1)||HanCal._noMajorST(m2))?HanCal._newMoonOnOrAfter(m2+1):m2;var m=HanCal._newMoonBefore(jd+1);this.priorLeapMonth=HanRataDie._priorLeapMonth(newYears,HanCal._newMoonBefore(m));this.leapMonth=this.leapYear&&HanCal._noMajorST(m)&&!this.priorLeapMonth};HanDate.prototype._calcDateComponents=function(){var remainder,jd=this.rd.getRataDie()+RataDie.gregorianEpoch;if(typeof this.offset==="undefined"){if(!this.tz){this.tz=new TimeZone({id:this.timezone})}this.offset=this.tz.getOffsetMillis(this)/864e5}if(this.offset!==0){jd+=this.offset}var gregyear=GregorianDate._calcYear(this.rd.getRataDie());this.year=gregyear+2697;var calc=HanCal._leapYearCalc(this.year);var m2=HanCal._newMoonOnOrAfter(calc.m1+1);this.leapYear=Math.round((calc.m2-calc.m1)/29.530588853)===12;var newYears=this.leapYear&&(HanCal._noMajorST(calc.m1)||HanCal._noMajorST(m2))?HanCal._newMoonOnOrAfter(m2+1):m2;if(jd<newYears){this.year--;calc=HanCal._leapYearCalc(this.year);m2=HanCal._newMoonOnOrAfter(calc.m1+1);this.leapYear=Math.round((calc.m2-calc.m1)/29.530588853)===12;newYears=this.leapYear&&(HanCal._noMajorST(calc.m1)||HanCal._noMajorST(m2))?HanCal._newMoonOnOrAfter(m2+1):m2}var m=HanCal._newMoonBefore(jd+1);this.month=Math.round((m-calc.m1)/29.530588853);this.priorLeapMonth=HanRataDie._priorLeapMonth(newYears,HanCal._newMoonBefore(m));this.leapMonth=this.leapYear&&HanCal._noMajorST(m)&&!this.priorLeapMonth;this.cycle=Math.floor((this.year-1)/60);this.cycleYear=MathUtils.amod(this.year,60);this.day=Astro._floorToJD(jd)-m+1;remainder=jd-Astro._floorToJD(jd);remainder=Math.round(remainder*864e5);this.hour=Math.floor(remainder/36e5);remainder-=this.hour*36e5;this.minute=Math.floor(remainder/6e4);remainder-=this.minute*6e4;this.second=Math.floor(remainder/1e3);remainder-=this.second*1e3;this.millisecond=remainder};HanDate.prototype.getCycleYears=function(){return this.cycleYear};HanDate.prototype.getCycles=function(){return this.cycle};HanDate.prototype.isLeapYear=function(){return this.leapYear};HanDate.prototype.isLeapMonth=function(){return this.leapMonth};HanDate.prototype.getDayOfWeek=function(){var rd=Math.floor(this.rd.getRataDie()+(this.offset||0));return MathUtils.mod(rd,7)};HanDate.prototype.getDayOfYear=function(){var newYears=this.cal.newYears(this.year);var priorNewMoon=HanCal._newMoonOnOrAfter(newYears+(this.month-1)*29);return priorNewMoon-newYears+this.day};HanDate.prototype.getEra=function(){return this.year<1?-1:1};HanDate.prototype.getCalendar=function(){return"han"};IDate._constructors["han"]=HanDate;module.exports=HanDate;