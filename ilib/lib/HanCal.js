var ilib=require("./ilib.js");var MathUtils=require("./MathUtils.js");var Calendar=require("./Calendar.js");var Astro=require("./Astro.js");var RataDie=require("./RataDie.js");var GregorianDate=require("./GregorianDate.js");var GregRataDie=require("./GregRataDie.js");var HanCal=function(params){this.type="han";var sync=params&&typeof params.sync==="boolean"?params.sync:true;Astro.initAstro(sync,params&&params.loadParams,ilib.bind(this,function(x){if(params&&typeof params.callback==="function"){params.callback(this)}}))};HanCal._getElapsedYear=function(year,cycle){var elapsedYear=year||0;if(typeof year!=="undefined"&&year<61&&typeof cycle!=="undefined"){elapsedYear=60*cycle+year}return elapsedYear};HanCal._hanNextSolarLongitude=function(jd,longitude){var tz=HanCal._chineseTZ(jd);var uni=Astro._universalFromLocal(jd,tz);var sol=Astro._nextSolarLongitude(uni,longitude);return Astro._localFromUniversal(sol,tz)};HanCal._majorSTOnOrAfter=function(jd){var tz=HanCal._chineseTZ(jd);var uni=Astro._universalFromLocal(jd,tz);var next=Astro._fixangle(30*Math.ceil(Astro._solarLongitude(uni)/30));return HanCal._hanNextSolarLongitude(jd,next)};HanCal._solsticeBefore=function(year,cycle){var elapsedYear=HanCal._getElapsedYear(year,cycle);var gregyear=elapsedYear-2697;var rd=new GregRataDie({year:gregyear-1,month:12,day:15,hour:0,minute:0,second:0,millisecond:0});return HanCal._majorSTOnOrAfter(rd.getRataDie()+RataDie.gregorianEpoch)};HanCal._chineseTZ=function(jd){var year=GregorianDate._calcYear(jd-RataDie.gregorianEpoch);return year<1929?465.6666666666667:480};HanCal._newMoonOnOrAfter=function(jd){var tz=HanCal._chineseTZ(jd);var uni=Astro._universalFromLocal(jd,tz);var moon=Astro._newMoonAtOrAfter(uni);return Astro._floorToJD(Astro._localFromUniversal(moon,tz))};HanCal._newMoonBefore=function(jd){var tz=HanCal._chineseTZ(jd);var uni=Astro._universalFromLocal(jd,tz);var moon=Astro._newMoonBefore(uni);return Astro._floorToJD(Astro._localFromUniversal(moon,tz))};HanCal._leapYearCalc=function(year,cycle){var ret={elapsedYear:HanCal._getElapsedYear(year,cycle)};ret.solstice1=HanCal._solsticeBefore(ret.elapsedYear);ret.solstice2=HanCal._solsticeBefore(ret.elapsedYear+1);ret.m1=HanCal._newMoonOnOrAfter(Astro._ceilToJD(ret.solstice1));ret.m2=HanCal._newMoonBefore(Astro._ceilToJD(ret.solstice2));return ret};HanCal._currentMajorST=function(jd){var s=Astro._solarLongitude(Astro._universalFromLocal(jd,HanCal._chineseTZ(jd)));return MathUtils.amod(2+Math.floor(s/30),12)};HanCal._noMajorST=function(jd){return HanCal._currentMajorST(jd)===HanCal._currentMajorST(HanCal._newMoonOnOrAfter(jd+1))};HanCal.prototype.getNumMonths=function(year,cycle){return this.isLeapYear(year,cycle)?13:12};HanCal.prototype.getMonLength=function(month,year){var calc=HanCal._leapYearCalc(year);var priorNewMoon=HanCal._newMoonOnOrAfter(calc.m1+month*29);var postNewMoon=HanCal._newMoonOnOrAfter(priorNewMoon+1);return postNewMoon-priorNewMoon};HanCal.prototype.equivalentCycleYear=function(year){var y=year-(year>=0?474:473);return MathUtils.mod(y,2820)+474};HanCal.prototype.isLeapYear=function(year,cycle){var calc=HanCal._leapYearCalc(year,cycle);return Math.round((calc.m2-calc.m1)/29.530588853)===12};HanCal.prototype.getLeapMonth=function(year,cycle){var calc=HanCal._leapYearCalc(year,cycle);if(Math.round((calc.m2-calc.m1)/29.530588853)!=12){return-1}var month=0;var m=HanCal._newMoonOnOrAfter(calc.m1+1);while(!HanCal._noMajorST(m)){month++;m=HanCal._newMoonOnOrAfter(m+1)}return month};HanCal.prototype.newYears=function(year,cycle){var calc=HanCal._leapYearCalc(year,cycle);var m2=HanCal._newMoonOnOrAfter(calc.m1+1);if(Math.round((calc.m2-calc.m1)/29.530588853)===12&&(HanCal._noMajorST(calc.m1)||HanCal._noMajorST(m2))){return HanCal._newMoonOnOrAfter(m2+1)}return m2};HanCal.prototype.getType=function(){return this.type};Calendar._constructors["han"]=HanCal;module.exports=HanCal;