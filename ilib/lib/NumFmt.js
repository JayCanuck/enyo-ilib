var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var MathUtils=require("./MathUtils.js");var Locale=require("./Locale.js");var LocaleInfo=require("./LocaleInfo.js");var Currency=require("./Currency.js");var IString=require("./IString.js");var INumber=require("./INumber.js");var NumFmt=function(options){var sync=true;this.locale=new Locale();this.type="number";var loadParams=undefined;if(options){if(options.locale){this.locale=typeof options.locale==="string"?new Locale(options.locale):options.locale}if(options.type){if(options.type==="number"||options.type==="currency"||options.type==="percentage"){this.type=options.type}}if(options.currency){this.currency=options.currency}if(typeof options.maxFractionDigits==="number"){this.maxFractionDigits=this._toPrimitive(options.maxFractionDigits)}if(typeof options.minFractionDigits==="number"){this.minFractionDigits=this._toPrimitive(options.minFractionDigits);if(this.minFractionDigits<0){this.minFractionDigits=0}if(this.minFractionDigits>20){this.minFractionDigits=20}}if(options.style){this.style=options.style}if(typeof options.useNative==="boolean"){this.useNative=options.useNative}this.roundingMode=options.roundingMode;if(typeof options.sync!=="undefined"){sync=options.sync==true}loadParams=options.loadParams}this.localeInfo=undefined;new LocaleInfo(this.locale,{sync:sync,loadParams:loadParams,onLoad:ilib.bind(this,function(li){this.localeInfo=li;if(this.type==="number"){this.templateNegative=new IString(this.localeInfo.getNegativeNumberFormat()||"-{n}")}else if(this.type==="currency"){var templates;if(!this.currency||typeof this.currency!="string"){throw"A currency property is required in the options to the number formatter constructor when the type property is set to currency."}new Currency({locale:this.locale,code:this.currency,sync:sync,loadParams:loadParams,onLoad:ilib.bind(this,function(cur){this.currencyInfo=cur;if(this.style!=="common"&&this.style!=="iso"){this.style="common"}if(typeof this.maxFractionDigits!=="number"&&typeof this.minFractionDigits!=="number"){this.minFractionDigits=this.maxFractionDigits=this.currencyInfo.getFractionDigits()}templates=this.localeInfo.getCurrencyFormats();this.template=new IString(templates[this.style]||templates.common);this.templateNegative=new IString(templates[this.style+"Negative"]||templates["commonNegative"]);this.sign=this.style==="iso"?this.currencyInfo.getCode():this.currencyInfo.getSign();if(!this.roundingMode){this.roundingMode=this.currencyInfo&&this.currencyInfo.roundingMode}this._init();if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})});return}else if(this.type==="percentage"){this.template=new IString(this.localeInfo.getPercentageFormat()||"{n}%");this.templateNegative=new IString(this.localeInfo.getNegativePercentageFormat()||this.localeInfo.getNegativeNumberFormat()+"%")}this._init();if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})})};NumFmt.getAvailableLocales=function(){return undefined};NumFmt.zeros="0000000000000000000000000000000000000000000000000000000000000000000000";NumFmt.prototype={getUseNative:function(){if(typeof this.useNative==="boolean"){return this.useNative}return this.localeInfo.getDigitsStyle()==="native"},_init:function(){if(this.maxFractionDigits<this.minFractionDigits){this.minFractionDigits=this.maxFractionDigits}if(!this.roundingMode){this.roundingMode=this.localeInfo.getRoundingMode()}if(!this.roundingMode){this.roundingMode="halfdown"}this.round=MathUtils[this.roundingMode];if(!this.round){this.roundingMode="halfdown";this.round=MathUtils[this.roundingMode]}if(this.style==="nogrouping"){this.prigroupSize=this.secgroupSize=0}else{this.prigroupSize=this.localeInfo.getPrimaryGroupingDigits();this.secgroupSize=this.localeInfo.getSecondaryGroupingDigits();this.groupingSeparator=this.getUseNative()?this.localeInfo.getNativeGroupingSeparator():this.localeInfo.getGroupingSeparator()}this.decimalSeparator=this.getUseNative()?this.localeInfo.getNativeDecimalSeparator():this.localeInfo.getDecimalSeparator();if(this.getUseNative()){var nd=this.localeInfo.getNativeDigits()||this.localeInfo.getDigits();if(nd){this.digits=nd.split("")}}this.exponentSymbol=this.localeInfo.getExponential()||"e"},_pad:function(str,length,left){return str.length>=length?str:left?NumFmt.zeros.substring(0,length-str.length)+str:str+NumFmt.zeros.substring(0,length-str.length)},_toPrimitive:function(num){var n=0;switch(typeof num){case"number":n=num;break;case"string":n=parseFloat(num);break;case"object":n=num.valueOf();break}return n},_formatScientific:function(num){var n=new Number(num);var formatted;var factor,str=n.toExponential(),parts=str.split("e"),significant=parts[0],exponent=parts[1],numparts,integral,fraction;if(this.maxFractionDigits>0){factor=Math.pow(10,this.maxFractionDigits);significant=this.round(significant*factor)/factor}numparts=(""+significant).split(".");integral=numparts[0];fraction=numparts[1];if(typeof this.maxFractionDigits!=="undefined"){fraction=fraction.substring(0,this.maxFractionDigits)}if(typeof this.minFractionDigits!=="undefined"){fraction=this._pad(fraction||"",this.minFractionDigits,false)}formatted=integral;if(fraction.length){formatted+=this.decimalSeparator+fraction}formatted+=this.exponentSymbol+exponent;return formatted},_formatStandard:function(num){var i;var k;if(typeof this.maxFractionDigits!=="undefined"&&this.maxFractionDigits>-1){var factor=Math.pow(10,this.maxFractionDigits);num=this.round(num*factor)/factor}num=Math.abs(num);var parts=(""+num).split("."),integral=parts[0],fraction=parts[1],cycle,formatted;integral=integral.toString();if(this.minFractionDigits>0){fraction=this._pad(fraction||"",this.minFractionDigits,false)}if(this.secgroupSize>0){if(integral.length>this.prigroupSize){var size1=this.prigroupSize;var size2=integral.length;var size3=size2-size1;integral=integral.slice(0,size3)+this.groupingSeparator+integral.slice(size3);var num_sec=integral.substring(0,integral.indexOf(this.groupingSeparator));k=num_sec.length;while(k>this.secgroupSize){var secsize1=this.secgroupSize;var secsize2=num_sec.length;var secsize3=secsize2-secsize1;integral=integral.slice(0,secsize3)+this.groupingSeparator+integral.slice(secsize3);num_sec=integral.substring(0,integral.indexOf(this.groupingSeparator));k=num_sec.length}}formatted=integral}else if(this.prigroupSize!==0){cycle=MathUtils.mod(integral.length-1,this.prigroupSize);formatted="";for(i=0;i<integral.length-1;i++){formatted+=integral.charAt(i);if(cycle===0){formatted+=this.groupingSeparator}cycle=MathUtils.mod(cycle-1,this.prigroupSize)}formatted+=integral.charAt(integral.length-1)}else{formatted=integral}if(fraction&&(typeof this.maxFractionDigits==="undefined"||this.maxFractionDigits>0)){formatted+=this.decimalSeparator;formatted+=fraction}if(this.digits){formatted=JSUtils.mapString(formatted,this.digits)}return formatted},format:function(num){var formatted,n;if(typeof num==="undefined"){return""}n=this._toPrimitive(num);if(this.type==="number"){formatted=this.style==="scientific"?this._formatScientific(n):this._formatStandard(n);if(num<0){formatted=this.templateNegative.format({n:formatted})}}else{formatted=this._formatStandard(n);var template=n<0?this.templateNegative:this.template;formatted=template.format({n:formatted,s:this.sign})}return formatted},getType:function(){return this.type},getLocale:function(){return this.locale},isGroupingUsed:function(){return this.groupingSeparator!=="undefined"&&this.groupingSeparator.length>0},getMaxFractionDigits:function(){return typeof this.maxFractionDigits!=="undefined"?this.maxFractionDigits:-1},getMinFractionDigits:function(){return typeof this.minFractionDigits!=="undefined"?this.minFractionDigits:-1},getCurrency:function(){return this.currencyInfo&&this.currencyInfo.getCode()},getRoundingMode:function(){return this.roundingMode},getStyle:function(){return this.style}};module.exports=NumFmt;