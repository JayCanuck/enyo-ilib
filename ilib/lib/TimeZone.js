var ilib=require("./ilib.js");var Utils=require("./Utils.js");var MathUtils=require("./MathUtils.js");var JSUtils=require("./JSUtils.js");var Locale=require("./Locale.js");var LocaleInfo=require("./LocaleInfo.js");var GregRataDie=require("./GregRataDie.js");var CalendarFactory=require("./CalendarFactory.js");var IString=require("./IString.js");var TimeZone=function(options){this.sync=true;this.locale=new Locale();this.isLocal=false;if(options){if(options.locale){this.locale=typeof options.locale==="string"?new Locale(options.locale):options.locale}if(options.id){var id=options.id.toString();if(id==="local"){this.isLocal=true;var now=new Date,jan1=new Date(now.getFullYear(),0,1),jun1=new Date(now.getFullYear(),5,1);this.offsetJan1=-jan1.getTimezoneOffset();this.offsetJun1=-jun1.getTimezoneOffset();this.offset=Math.min(this.offsetJan1,this.offsetJun1)}this.id=id}else if(options.offset){this.offset=typeof options.offset==="string"?parseInt(options.offset,10):options.offset;this.id=this.getDisplayName(undefined,undefined)}if(typeof options.sync!=="undefined"){this.sync=!!options.sync}this.loadParams=options.loadParams;this.onLoad=options.onLoad}if(!this.id){new LocaleInfo(this.locale,{sync:this.sync,onLoad:ilib.bind(this,function(li){this.id=li.getTimeZone()||"Etc/UTC";this._loadtzdata()})})}else{this._loadtzdata()}};TimeZone.prototype._loadtzdata=function(){if(!ilib.data.zoneinfo[this.id]&&typeof this.offset==="undefined"){Utils.loadData({object:TimeZone,nonlocale:true,name:"zoneinfo/"+this.id+".json",sync:this.sync,loadParams:this.loadParams,callback:ilib.bind(this,function(tzdata){if(tzdata&&!JSUtils.isEmpty(tzdata)){ilib.data.zoneinfo[this.id]=tzdata}this._initZone()})})}else{this._initZone()}};TimeZone.prototype._initZone=function(){this.zone=ilib.data.zoneinfo[this.id];if(!this.zone&&typeof this.offset==="undefined"){this.id="Etc/UTC";this.zone=ilib.data.zoneinfo[this.id]}this._calcDSTSavings();if(typeof this.offset==="undefined"&&this.zone.o){var offsetParts=this._offsetStringToObj(this.zone.o);this.offset=(Math.abs(offsetParts.h||0)*60+(offsetParts.m||0))*MathUtils.signum(offsetParts.h||0)}if(this.onLoad&&typeof this.onLoad==="function"){this.onLoad(this)}};TimeZone._marshallIds=function(country,sync,callback){var tz,ids=[];if(!country){ids.push("local");for(tz in ilib.data.timezones){if(ilib.data.timezones[tz]){ids.push(ilib.data.timezones[tz])}}if(typeof callback==="function"){callback(ids)}}else{if(!ilib.data.zoneinfo.zonetab){Utils.loadData({object:TimeZone,nonlocale:true,name:"zoneinfo/zonetab.json",sync:sync,callback:ilib.bind(this,function(tzdata){if(tzdata){ilib.data.zoneinfo.zonetab=tzdata}ids=ilib.data.zoneinfo.zonetab[country];if(typeof callback==="function"){callback(ids)}})})}else{ids=ilib.data.zoneinfo.zonetab[country];if(typeof callback==="function"){callback(ids)}}}return ids};TimeZone.getAvailableIds=function(country,sync,onLoad){var tz,ids=[];if(typeof sync!=="boolean"){sync=true}if(ilib.data.timezones.length===0){if(typeof ilib._load!=="undefined"&&typeof ilib._load.listAvailableFiles==="function"){ilib._load.listAvailableFiles(sync,function(hash){for(var dir in hash){var files=hash[dir];if(ilib.isArray(files)){files.forEach(function(filename){if(filename&&filename.match(/^zoneinfo/)){ilib.data.timezones.push(filename.replace(/^zoneinfo\//,"").replace(/\.json$/,""))}})}}ids=TimeZone._marshallIds(country,sync,onLoad)})}else{for(tz in ilib.data.zoneinfo){if(ilib.data.zoneinfo[tz]){ilib.data.timezones.push(tz)}}ids=TimeZone._marshallIds(country,sync,onLoad)}}else{ids=TimeZone._marshallIds(country,sync,onLoad)}return ids};TimeZone.prototype.getId=function(){return this.id.toString()};TimeZone.prototype.getDisplayName=function(date,style){style=this.isLocal||typeof this.zone==="undefined"?"rfc822":style||"standard";switch(style){default:case"standard":if(this.zone.f&&this.zone.f!=="zzz"){if(this.zone.f.indexOf("{c}")!==-1){var letter="";letter=this.inDaylightTime(date)?this.zone.s&&this.zone.s.c:this.zone.e&&this.zone.e.c;var temp=new IString(this.zone.f);return temp.format({c:letter||""})}return this.zone.f}var temp="GMT"+this.zone.o;if(this.inDaylightTime(date)){temp+="+"+this.zone.s.v}return temp;break;case"rfc822":var offset=this.getOffset(date),ret="UTC",hour=offset.h||0,minute=offset.m||0;if(hour!==0){ret+=hour>0?"+":"-";if(Math.abs(hour)<10){ret+="0"}ret+=hour<0?-hour:hour;if(minute<10){ret+="0"}ret+=minute}return ret;case"long":if(this.zone.n){if(this.zone.n.indexOf("{c}")!==-1){var str=this.inDaylightTime(date)?"Daylight":"Standard";var temp=new IString(this.zone.n);return temp.format({c:str||""})}return this.zone.n}var temp="GMT"+this.zone.o;if(this.inDaylightTime(date)){temp+="+"+this.zone.s.v}return temp;break}};TimeZone.prototype._offsetStringToObj=function(str){var offsetParts=typeof str==="string"?str.split(":"):[],ret={h:0},temp;if(offsetParts.length>0){ret.h=parseInt(offsetParts[0],10);if(offsetParts.length>1){temp=parseInt(offsetParts[1],10);if(temp){ret.m=temp}if(offsetParts.length>2){temp=parseInt(offsetParts[2],10);if(temp){ret.s=temp}}}}return ret};TimeZone.prototype.getOffset=function(date){if(!date){return this.getRawOffset()}var offset=this.getOffsetMillis(date)/6e4;var hours=MathUtils.down(offset/60),minutes=Math.abs(offset)-Math.abs(hours)*60;var ret={h:hours};if(minutes!=0){ret.m=minutes}return ret};TimeZone.prototype.getOffsetMillis=function(date){var ret;if(this.isLocal&&typeof date.dst==="undefined"){var d=!date?new Date:new Date(date.getTimeExtended());return-d.getTimezoneOffset()*6e4}ret=this.offset;if(date&&this.inDaylightTime(date)){ret+=this.dstSavings}return ret*6e4};TimeZone.prototype._getOffsetMillisWallTime=function(date){var ret;ret=this.offset;if(date&&this.inDaylightTime(date,true)){ret+=this.dstSavings}return ret*6e4};TimeZone.prototype.getOffsetStr=function(date){var offset=this.getOffset(date),ret;ret=offset.h;if(typeof offset.m!=="undefined"){ret+=":"+offset.m;if(typeof offset.s!=="undefined"){ret+=":"+offset.s}}else{ret+=":0"}return ret};TimeZone.prototype.getRawOffset=function(){var hours=MathUtils.down(this.offset/60),minutes=Math.abs(this.offset)-Math.abs(hours)*60;var ret={h:hours};if(minutes!=0){ret.m=minutes}return ret};TimeZone.prototype.getRawOffsetMillis=function(){return this.offset*6e4};TimeZone.prototype.getRawOffsetStr=function(){var off=this.getRawOffset();return off.h+":"+(off.m||"0")};TimeZone.prototype.getDSTSavings=function(){if(this.isLocal){var savings=Math.abs(this.offsetJan1-this.offsetJun1);var hours=MathUtils.down(savings/60),minutes=savings-hours*60;return{h:hours,m:minutes}}else if(this.zone&&this.zone.s){return this._offsetStringToObj(this.zone.s.v)}return{h:0}};TimeZone.prototype.getDSTSavingsStr=function(){if(this.isLocal){var savings=this.getDSTSavings();return savings.h+":"+savings.m}else if(typeof this.offset!=="undefined"&&this.zone&&this.zone.s){return this.zone.s.v}return"0:0"};TimeZone.prototype._calcRuleStart=function(rule,year){var type="=",weekday=0,day,refDay,cal,hour=0,minute=0,second=0,time,i;if(typeof rule.j!=="undefined"){refDay=new GregRataDie({julianday:rule.j})}else{if(rule.r.charAt(0)=="l"||rule.r.charAt(0)=="f"){cal=CalendarFactory({type:"gregorian"});type=rule.r.charAt(0);weekday=parseInt(rule.r.substring(1),10);day=type==="l"?cal.getMonLength(rule.m,year):1}else{i=rule.r.indexOf("<");if(i==-1){i=rule.r.indexOf(">")}if(i!=-1){type=rule.r.charAt(i);weekday=parseInt(rule.r.substring(0,i),10);day=parseInt(rule.r.substring(i+1),10)}else{day=parseInt(rule.r,10)}}if(rule.t){time=rule.t.split(":");hour=parseInt(time[0],10);if(time.length>1){minute=parseInt(time[1],10);if(time.length>2){second=parseInt(time[2],10)}}}refDay=new GregRataDie({year:year,month:rule.m,day:day,hour:hour,minute:minute,second:second})}var d=refDay.getRataDie();switch(type){case"l":case"<":d=refDay.onOrBefore(weekday);break;case"f":case">":d=refDay.onOrAfter(weekday);break}return d};TimeZone.prototype._calcDSTSavings=function(){var saveParts=this.getDSTSavings();this.dstSavings=(Math.abs(saveParts.h||0)*60+(saveParts.m||0))*MathUtils.signum(saveParts.h||0)};TimeZone.prototype._getDSTStartRule=function(year){return this.zone.s};TimeZone.prototype._getDSTEndRule=function(year){return this.zone.e};TimeZone.prototype.inDaylightTime=function(date,wallTime){var rd,startRd,endRd,year;if(this.isLocal){var offset=0;if(typeof date.dst!=="undefined"&&!date.dst){offset=this.dstSavings*6e4}var d=new Date(date?date.getTimeExtended()+offset:undefined);var dst=Math.max(this.offsetJan1,this.offsetJun1);return-d.getTimezoneOffset()===dst}if(!date||!date.cal||date.cal.type!=="gregorian"){var time=date&&typeof date.getTimeExtended==="function"?date.getTimeExtended():undefined;rd=new GregRataDie({unixtime:time}).getRataDie();year=new Date(time).getUTCFullYear()}else{rd=date.rd.getRataDie();year=date.year}if(!this.useDaylightTime(year)){return false}var startrule=this._getDSTStartRule(year);var endrule=this._getDSTEndRule(year);startRd=this._calcRuleStart(startrule,year);endRd=this._calcRuleStart(endrule,year);if(wallTime){startRd+=this.dstSavings/1440}else{startRd-=this.offset/1440;endRd-=(this.offset+this.dstSavings)/1440}if(rd<endRd&&endRd-rd<=this.dstSavings/1440&&typeof date.dst==="boolean"){return date.dst}if(startRd<endRd){return rd>=startRd&&rd<endRd?true:false}return rd>=startRd||rd<endRd?true:false};TimeZone.prototype.useDaylightTime=function(year){return this.isLocal&&this.offsetJan1!==this.offsetJun1||typeof this.zone!=="undefined"&&typeof this.zone.s!=="undefined"&&typeof this.zone.e!=="undefined"};TimeZone.prototype.getCountry=function(){return this.zone.c};module.exports=TimeZone;