var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var Locale=require("./Locale.js");var IString=require("./IString.js");var CType=require("./CType.js");var isAlpha=require("./isAlpha.js");var isIdeo=require("./isIdeo.js");var isPunct=require("./isPunct.js");var isSpace=require("./isSpace.js");var Name=function(name,options){var sync=true;if(!name||name.length===0){return}this.loadParams={};if(options){if(options.locale){this.locale=typeof options.locale==="string"?new Locale(options.locale):options.locale}if(options.style&&(options.style==="asian"||options.style==="western")){this.style=options.style}if(options.order&&(options.order==="gmf"||options.order==="fmg"||options.order==="fgm")){this.order=options.order}if(typeof options.sync!=="undefined"){sync=options.sync==true}if(typeof options.loadParams!=="undefined"){this.loadParams=options.loadParams}}if(!Name.cache){Name.cache={}}this.locale=this.locale||new Locale();isAlpha._init(sync,this.loadParams,ilib.bind(this,function(){isIdeo._init(sync,this.loadParams,ilib.bind(this,function(){isPunct._init(sync,this.loadParams,ilib.bind(this,function(){isSpace._init(sync,this.loadParams,ilib.bind(this,function(){Utils.loadData({object:Name,locale:this.locale,name:"name.json",sync:sync,loadParams:this.loadParams,callback:ilib.bind(this,function(info){if(!info){info=Name.defaultInfo;var spec=this.locale.getSpec().replace(/-/g,"_");Name.cache[spec]=info}if(typeof name==="object"){this.prefix=name.prefix;this.givenName=name.givenName;this.middleName=name.middleName;this.familyName=name.familyName;this.suffix=name.suffix;this.locale=name.locale;this.style=name.style;this.order=name.order;this.useSpaces=name.useSpaces;this.isAsianName=name.isAsianName;return}this.info=info;this._init(name);if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})})}))}))}))}))};Name.defaultInfo=ilib.data.name||{components:{"short":{g:1,f:1},medium:{g:1,m:1,f:1},"long":{p:1,g:1,m:1,f:1},full:{p:1,g:1,m:1,f:1,s:1}},format:"{prefix} {givenName} {middleName} {familyName}{suffix}",sortByHeadWord:false,nameStyle:"western",conjunctions:{and1:"and",and2:"and",or1:"or",or2:"or"},auxillaries:{von:1,"von der":1,"von den":1,van:1,"van der":1,"van de":1,"van den":1,de:1,di:1,la:1,lo:1,des:1,le:1,les:1,du:1,"de la":1,del:1,"de los":1,"de las":1},prefixes:["doctor","dr","mr","mrs","ms","mister","madame","madamoiselle","miss","monsieur","señor","señora","señorita"],suffixes:[",","junior","jr","senior","sr","i","ii","iii","esq","phd","md"],patronymicName:[],familyNames:[]};Name._isAsianChar=function(c){return isIdeo(c)||CType.withinRange(c,"hangul")||CType.withinRange(c,"hiragana")||CType.withinRange(c,"katakana")};Name._isAsianName=function(name,language){var asian=0,latin=0,i;if(name&&name.length>0){for(i=0;i<name.length;i++){var c=name.charAt(i);if(Name._isAsianChar(c)){if(language=="ko"||language=="ja"||language=="zh"){return true}asian++}else if(isAlpha(c)){if(!language=="ko"||!language=="ja"||!language=="zh"){return false}latin++}}return latin<asian}return false};Name._isEuroName=function(name,language){var c,n=new IString(name),it=n.charIterator();while(it.hasNext()){c=it.next();if(!Name._isAsianChar(c)&&!isPunct(c)&&!isSpace(c)){return true}else if(Name._isAsianChar(c)&&(language=="ko"||language=="ja"||language=="zh")){return false}}return false};Name.prototype={_init:function(name){var parts,prefixArray,prefix,prefixLower,suffixArray,suffix,suffixLower,i,info,hpSuffix;var currentLanguage=this.locale.getLanguage();if(name){i=name.search(/\s*[,\/\(\[\{<]/);if(i!==-1){hpSuffix=name.substring(i);hpSuffix=hpSuffix.replace(/\s+/g," ");suffixArray=hpSuffix.split(" ");var conjunctionIndex=this._findLastConjunction(suffixArray);if(conjunctionIndex>-1){hpSuffix=undefined}else{name=name.substring(0,i)}}this.isAsianName=Name._isAsianName(name,currentLanguage);if(this.info.nameStyle==="asian"||this.info.order==="fmg"||this.info.order==="fgm"){info=this.isAsianName?this.info:ilib.data.name}else{info=this.isAsianName?ilib.data.name:this.info}if(this.isAsianName){if(this.useSpaces==false){name=name.replace(/\s+/g,"")}parts=name.trim().split("")}else{name=name.replace(/, /g," , ");name=name.replace(/\s+/g," ");parts=name.trim().split(" ")}if(parts.length>1){for(i=parts.length;i>0;i--){prefixArray=parts.slice(0,i);prefix=prefixArray.join(this.isAsianName?"":" ");prefixLower=prefix.toLowerCase();prefixLower=prefixLower.replace(/[,\.]/g,"");if(ilib.isArray(this.info.prefixes)&&(JSUtils.indexOf(this.info.prefixes,prefixLower)>-1||this._isConjunction(prefixLower))){if(this.prefix){if(!this.isAsianName){this.prefix+=" "}this.prefix+=prefix}else{this.prefix=prefix}parts=parts.slice(i);i=parts.length}}}if(parts.length>1){for(i=parts.length;i>0;i--){suffixArray=parts.slice(-i);suffix=suffixArray.join(this.isAsianName?"":" ");suffixLower=suffix.toLowerCase();suffixLower=suffixLower.replace(/[\.]/g,"");if(ilib.isArray(this.info.suffixes)&&JSUtils.indexOf(this.info.suffixes,suffixLower)>-1){if(this.suffix){if(!this.isAsianName&&!isPunct(this.suffix.charAt(0))){this.suffix=" "+this.suffix}this.suffix=suffix+this.suffix}else{this.suffix=suffix}parts=parts.slice(0,parts.length-i);i=parts.length}}}if(hpSuffix){this.suffix=this.suffix&&this.suffix+hpSuffix||hpSuffix}if(parts.length>1&&!this.isAsianName){parts=this._joinAuxillaries(parts,this.isAsianName)}if(this.isAsianName){this._parseAsianName(parts,currentLanguage)}else{this._parseWesternName(parts)}this._joinNameArrays()}},_findPrefix:function(parts,names,isAsian,noCompoundPrefix){var i,prefix,prefixLower,prefixArray,aux=[];if(parts.length>0&&names){for(i=parts.length;i>0;i--){prefixArray=parts.slice(0,i);prefix=prefixArray.join(isAsian?"":" ");prefixLower=prefix.toLowerCase();prefixLower=prefixLower.replace(/[,\.]/g,"");if(prefixLower in names){aux=aux.concat(isAsian?prefix:prefixArray);if(noCompoundPrefix){return aux}parts=parts.slice(i);i=parts.length+1}}}return aux},_findSuffix:function(parts,names,isAsian){var i,j,seq="";for(i=0;i<names.length;i++){if(parts.length>=names[i].length){j=0;while(j<names[i].length&&parts[parts.length-j]===names[i][names[i].length-j]){j++}if(j>=names[i].length){seq=parts.slice(parts.length-j).join(isAsian?"":" ")+(isAsian?"":" ")+seq;parts=parts.slice(0,parts.length-j);i=-1}}}this.suffix=seq;return parts},_isConjunction:function _isConjunction(word){return this.info.conjunctions.and1===word||this.info.conjunctions.and2===word||this.info.conjunctions.or1===word||this.info.conjunctions.or2===word||"&"===word||"+"===word},_findLastConjunction:function _findLastConjunction(parts){var conjunctionIndex=-1,index,part;for(index=0;index<parts.length;index++){part=parts[index];if(typeof part==="string"){part=part.toLowerCase();if("and"===part||"or"===part||"&"===part||"+"===part){conjunctionIndex=index}if(this._isConjunction(part)){conjunctionIndex=index}}}return conjunctionIndex},_extractPrefixes:function(parts,isAsian){var i=this._findPrefix(parts,this.info.prefixes,isAsian);if(i>0){this.prefix=parts.slice(0,i).join(isAsian?"":" ");return parts.slice(i)}return parts},_extractSuffixes:function(parts,isAsian){var i=this._findSuffix(parts,this.info.suffixes,isAsian);if(i>0){this.suffix=parts.slice(i).join(isAsian?"":" ");return parts.slice(0,i)}return parts},_joinAuxillaries:function(parts,isAsian){var start,i,prefixArray,prefix,prefixLower;if(this.info.auxillaries&&(parts.length>2||this.prefix)){for(start=0;start<parts.length-1;start++){for(i=parts.length;i>start;i--){prefixArray=parts.slice(start,i);prefix=prefixArray.join(" ");prefixLower=prefix.toLowerCase();prefixLower=prefixLower.replace(/[,\.]/g,"");if(prefixLower in this.info.auxillaries){parts.splice(start,i+1-start,prefixArray.concat(parts[i]));i=start}}}}return parts},_joinArrayOrString:function _joinArrayOrString(part){var i;if(typeof part==="object"){for(i=0;i<part.length;i++){part[i]=this._joinArrayOrString(part[i])}var ret="";part.forEach(function(segment){if(ret.length>0&&!isPunct(segment.charAt(0))){ret+=" "}ret+=segment});return ret}return part},_joinNameArrays:function _joinNameArrays(){var prop;for(prop in this){if(this[prop]!==undefined&&typeof this[prop]==="object"&&this[prop]instanceof Array){this[prop]=this._joinArrayOrString(this[prop])}}},_parseAsianName:function(parts,language){var familyNameArray=this._findPrefix(parts,this.info.knownFamilyNames,true,this.info.noCompoundFamilyNames);var tempFullName=parts.join("");if(familyNameArray&&familyNameArray.length>0){this.familyName=familyNameArray.join("");this.givenName=parts.slice(this.familyName.length).join("");if(language==="ko"&&tempFullName.search(/\s*[/\s]/)>-1&&!this.suffix){this._parseKoreanName(tempFullName)}}else if(this.locale.getLanguage()==="ja"){this._parseJapaneseName(parts)}else if(this.suffix||this.prefix){this.familyName=parts.join("")}else{this.givenName=parts.join("")}},_parseKoreanName:function(name){var tempName=name;var spaceSplit=tempName.split(" ");var spceCount=spaceSplit.length;var fistSpaceIndex=tempName.indexOf(" ");var lastSpaceIndex=tempName.lastIndexOf(" ");if(spceCount===2){this.familyName=spaceSplit[0];this.givenName=tempName.slice(fistSpaceIndex,tempName.length)}else{this.familyName=spaceSplit[0];this.middleName=tempName.slice(fistSpaceIndex,lastSpaceIndex);this.givenName=tempName.slice(lastSpaceIndex,tempName.length)}},_parseJapaneseName:function(parts){if(this.suffix&&this.suffix.length>1&&this.info.honorifics.indexOf(this.suffix)>-1){if(parts.length===1){if(CType.withinRange(parts[0],"cjk")){this.familyName=parts[0]}else{this.givenName=parts[0]}return}else if(parts.length===2){this.familyName=parts.slice(0,parts.length).join("");return}}if(parts.length>1){var fn="";for(var i=0;i<parts.length;i++){if(CType.withinRange(parts[i],"cjk")){fn+=parts[i]}else if(fn.length>1&&CType.withinRange(parts[i],"hiragana")){this.familyName=fn;this.givenName=parts.slice(i,parts.length).join("");return}else{break;}}}if(parts.length===1){this.familyName=parts[0]}else if(parts.length===2){this.familyName=parts[0];this.givenName=parts[1]}else if(parts.length===3){this.familyName=parts[0];this.givenName=parts.slice(1,parts.length).join("")}else if(parts.length>3){this.familyName=parts.slice(0,2).join("");this.givenName=parts.slice(2,parts.length).join("")}},_parseSpanishName:function(parts){var conjunctionIndex;if(parts.length===1){if(this.prefix||typeof parts[0]==="object"){this.familyName=parts[0]}else{this.givenName=parts[0]}}else if(parts.length===2){this.givenName=parts[0];this.familyName=parts[1]}else if(parts.length===3){conjunctionIndex=this._findLastConjunction(parts);if(conjunctionIndex===1){this.givenName=parts}else{this.givenName=parts[0];this.familyName=parts.slice(1)}}else if(parts.length>3){conjunctionIndex=this._findLastConjunction(parts);if(conjunctionIndex>0){this.givenName=parts.splice(0,conjunctionIndex+2);if(parts.length>1){this.familyName=parts.splice(parts.length-2,2);if(parts.length>0){this.middleName=parts}}else if(parts.length===1){this.familyName=parts[0]}}else{this.givenName=parts.splice(0,1);this.familyName=parts.splice(parts.length-2,2);this.middleName=parts}}},_parseIndonesianName:function(parts){var conjunctionIndex;if(parts.length===1){this.givenName=parts[0]}else if(parts.length>=2){conjunctionIndex=this._findLastConjunction(parts);if(conjunctionIndex>0){this.givenName=parts.splice(0,conjunctionIndex+2);if(parts.length>1){this.middleName=parts}}else{this.givenName=parts.splice(0,1);this.middleName=parts}}},_parseGenericWesternName:function(parts){var conjunctionIndex;if(parts.length===1){if(this.prefix||typeof parts[0]==="object"){this.familyName=parts[0]}else{this.givenName=parts[0]}}else if(parts.length===2){if(this.info.order=="fgm"){this.givenName=parts[1];this.familyName=parts[0]}else if(this.info.order=="gmf"||typeof this.info.order=="undefined"){this.givenName=parts[0];this.familyName=parts[1]}}else if(parts.length>=3){conjunctionIndex=this._findLastConjunction(parts);if(conjunctionIndex>0){this.givenName=parts.slice(0,conjunctionIndex+2);if(conjunctionIndex+1<parts.length-1){this.familyName=parts.splice(parts.length-1,1);if(conjunctionIndex+2<parts.length-1){this.middleName=parts.slice(conjunctionIndex+2,parts.length-conjunctionIndex-3)}}else if(this.order=="fgm"){this.familyName=parts.slice(0,conjunctionIndex+2);if(conjunctionIndex+1<parts.length-1){this.middleName=parts.splice(parts.length-1,1);if(conjunctionIndex+2<parts.length-1){this.givenName=parts.slice(conjunctionIndex+2,parts.length-conjunctionIndex-3)}}}}else{this.givenName=parts[0];this.middleName=parts.slice(1,parts.length-1);this.familyName=parts[parts.length-1]}}},_findPatronymicName:function(parts){var index,part;for(index=0;index<parts.length;index++){part=parts[index];if(typeof part==="string"){part=part.toLowerCase();var subLength=this.info.patronymicName.length;while(subLength--){if(part.indexOf(this.info.patronymicName[subLength])!==-1)return index}}}return-1},_isPatronymicName:function(part){var pName;if(typeof part==="string"){pName=part.toLowerCase();var subLength=this.info.patronymicName.length;while(subLength--){if(pName.indexOf(this.info.patronymicName[subLength])!==-1)return true}}return false},_findFamilyName:function(parts){var index,part,substring;for(index=0;index<parts.length;index++){part=parts[index];if(typeof part==="string"){part=part.toLowerCase();var length=part.length-1;if(this.info.familyName.indexOf(part)!==-1){return index}else if(part[length]==="в"||part[length]==="н"||part[length]==="й"){substring=part.slice(0,-1);if(this.info.familyName.indexOf(substring)!==-1){return index}}else if(part[length-1]==="в"&&part[length]==="а"||part[length-1]==="н"&&part[length]==="а"||part[length-1]==="а"&&part[length]==="я"){substring=part.slice(0,-2);if(this.info.familyName.indexOf(substring)!==-1){return index}}}}return-1},_parseRussianName:function(parts){var conjunctionIndex,familyIndex=-1;if(parts.length===1){if(this.prefix||typeof parts[0]==="object"){this.familyName=parts[0]}else{this.givenName=parts[0]}}else if(parts.length===2){if(this.info.order==="fgm"){this.givenName=parts[1];this.familyName=parts[0]}else if(this.info.order==="gmf"){this.givenName=parts[0];this.familyName=parts[1]}else if(typeof this.info.order==="undefined"){if(this._isPatronymicName(parts[1])===true){this.middleName=parts[1];this.givenName=parts[0]}else if((familyIndex=this._findFamilyName(parts))!==-1){if(familyIndex===1){this.givenName=parts[0];this.familyName=parts[1]}else{this.familyName=parts[0];this.givenName=parts[1]}}else{this.givenName=parts[0];this.familyName=parts[1]}}}else if(parts.length>=3){conjunctionIndex=this._findLastConjunction(parts);var patronymicNameIndex=this._findPatronymicName(parts);if(conjunctionIndex>0){this.givenName=parts.slice(0,conjunctionIndex+2);if(conjunctionIndex+1<parts.length-1){this.familyName=parts.splice(parts.length-1,1);if(conjunctionIndex+2<parts.length-1){this.middleName=parts.slice(conjunctionIndex+2,parts.length-conjunctionIndex-3)}}else if(this.order=="fgm"){this.familyName=parts.slice(0,conjunctionIndex+2);if(conjunctionIndex+1<parts.length-1){this.middleName=parts.splice(parts.length-1,1);if(conjunctionIndex+2<parts.length-1){this.givenName=parts.slice(conjunctionIndex+2,parts.length-conjunctionIndex-3)}}}}else if(patronymicNameIndex!==-1){this.middleName=parts[patronymicNameIndex];if(patronymicNameIndex===parts.length-1){this.familyName=parts[0];this.givenName=parts.slice(1,patronymicNameIndex)}else{this.givenName=parts.slice(0,patronymicNameIndex);this.familyName=parts[parts.length-1]}}else{this.givenName=parts[0];this.middleName=parts.slice(1,parts.length-1);this.familyName=parts[parts.length-1]}}},_parseWesternName:function(parts){if(this.locale.getLanguage()==="es"||this.locale.getLanguage()==="pt"){this._parseSpanishName(parts)}else if(this.locale.getLanguage()==="ru"){this._parseRussianName(parts)}else if(this.locale.getLanguage()==="id"){this._parseIndonesianName(parts)}else{this._parseGenericWesternName(parts)}},getSortFamilyName:function(){var name,auxillaries,auxString,parts,i;if(!this.familyName){return undefined}if(this.info){if(this.info.sortByHeadWord){if(typeof this.familyName==="string"){name=this.familyName.replace(/\s+/g," ");parts=name.trim().split(" ")}else{parts=this.familyName}auxillaries=this._findPrefix(parts,this.info.auxillaries,false);if(auxillaries&&auxillaries.length>0){if(typeof this.familyName==="string"){auxString=auxillaries.join(" ");name=this.familyName.substring(auxString.length+1)+", "+auxString}else{name=parts.slice(auxillaries.length).join(" ")+", "+parts.slice(0,auxillaries.length).join(" ")}}}else if(this.info.knownFamilyNames&&this.familyName){parts=this.familyName.split("");var familyNameArray=this._findPrefix(parts,this.info.knownFamilyNames,true,this.info.noCompoundFamilyNames);name="";for(i=0;i<familyNameArray.length;i++){name+=this.info.knownFamilyNames[familyNameArray[i]]||""}}}return name||this.familyName},getHeadFamilyName:function(){},clone:function(){return new Name(this)}};module.exports=Name;