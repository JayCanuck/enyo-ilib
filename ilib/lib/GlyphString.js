var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var IString=require("./IString.js");var CType=require("./CType.js");var GlyphString=function(str,options){if(options&&options.noinstance){return}IString.call(this,str);var sync=true;var loadParams={};if(options){if(typeof options.sync==="boolean"){sync=options.sync}if(options.loadParams){loadParams=options.loadParams}}CType._load("ctype_m",sync,loadParams,function(){if(!ilib.data.norm||JSUtils.isEmpty(ilib.data.norm.ccc)){Utils.loadData({object:GlyphString,locale:"-",name:"normdata.json",nonlocale:true,sync:sync,loadParams:loadParams,callback:ilib.bind(this,function(norm){ilib.extend(ilib.data.norm,norm);if(options&&typeof options.onLoad==="function"){options.onLoad(this)}})})}else{if(options&&typeof options.onLoad==="function"){options.onLoad(this)}}})};GlyphString.prototype=new IString(undefined);GlyphString.prototype.parent=IString;GlyphString.prototype.constructor=GlyphString;GlyphString._isJamoL=function(n){return n>=4352&&n<=4370};GlyphString._isJamoV=function(n){return n>=4449&&n<=4469};GlyphString._isJamoT=function(n){return n>=4520&&n<=4546};GlyphString._isHangul=function(n){return n>=44032&&n<=55203};GlyphString._composeJamoLV=function(lead,trail){var lindex=lead-4352;var vindex=trail-4449;return IString.fromCodePoint(44032+(lindex*21+vindex)*28)};GlyphString._composeJamoLVT=function(lead,trail){return IString.fromCodePoint(lead+(trail-4519))};GlyphString._compose=function(lead,trail){var first=lead.charCodeAt(0);var last=trail.charCodeAt(0);if(GlyphString._isHangul(first)&&GlyphString._isJamoT(last)){return GlyphString._composeJamoLVT(first,last)}else if(GlyphString._isJamoL(first)&&GlyphString._isJamoV(last)){return GlyphString._composeJamoLV(first,last)}var c=lead+trail;return ilib.data.norm.nfc&&ilib.data.norm.nfc[c]};GlyphString.prototype.charIterator=function(){var it=IString.prototype.charIterator.call(this);function _chiterator(istring){this.index=0;this.spacingCombining=false;this.hasNext=function(){return!!this.nextChar||it.hasNext()};this.next=function(){var ch=this.nextChar||it.next(),prevCcc=ilib.data.norm.ccc[ch],nextCcc,composed=ch;this.nextChar=undefined;this.spacingCombining=false;if(ilib.data.norm.ccc&&(typeof ilib.data.norm.ccc[ch]==="undefined"||ilib.data.norm.ccc[ch]===0)){var notdone=true;while(it.hasNext()&&notdone){this.nextChar=it.next();nextCcc=ilib.data.norm.ccc[this.nextChar];var codePoint=IString.toCodePoint(this.nextChar,0);var isMn=CType._inRange(codePoint,"Mn",ilib.data.ctype_m);var isMc=CType._inRange(codePoint,"Mc",ilib.data.ctype_m);if(isMn||isMc||typeof nextCcc!=="undefined"&&nextCcc!==0){if(isMc){this.spacingCombining=true}ch+=this.nextChar;this.nextChar=undefined}else{var testChar=GlyphString._compose(composed,this.nextChar);if(prevCcc===0&&typeof testChar!=="undefined"){composed=testChar;ch+=this.nextChar;this.nextChar=undefined}else{notdone=false}}prevCcc=nextCcc}}return ch};this.wasSpacingCombining=function(){return this.spacingCombining}}return new _chiterator(this)};GlyphString.prototype.truncate=function(length){var it=this.charIterator();var tr="";for(var i=0;i<length-1&&it.hasNext();i++){tr+=it.next()}if(i<length&&it.hasNext()){var c=it.next();if(!it.wasSpacingCombining()){tr+=c}}return tr};GlyphString.prototype.ellipsize=function(length){return this.truncate(length>0?length-1:0)+"â€¦"};module.exports=GlyphString;