var ilib=require("./ilib.js");var Utils=require("./Utils.js");var JSUtils=require("./JSUtils.js");var Locale=require("./Locale.js");var NumberingPlan=require("./NumberingPlan.js");var PhoneLocale=require("./PhoneLocale.js");var PhoneHandlerFactory=require("./PhoneHandlerFactory.js");var PhoneNumber=function(number,options){var stateData,regionSettings;this.sync=true;this.loadParams={};if(!number||typeof number==="string"&&number.length===0){return this}if(options){if(typeof options.sync==="boolean"){this.sync=options.sync}if(options.loadParams){this.loadParams=options.loadParams}if(typeof options.onLoad==="function"){this.onLoad=options.onLoad}}if(typeof number==="object"){this.vsc=number.vsc;this.iddPrefix=number.iddPrefix;this.countryCode=number.countryCode;this.trunkAccess=number.trunkAccess;this.cic=number.cic;this.emergency=number.emergency;this.mobilePrefix=number.mobilePrefix;this.serviceCode=number.serviceCode;this.areaCode=number.areaCode;this.subscriberNumber=number.subscriberNumber;this.extension=number.extension;this.invalid=number.invalid;if(number.plan&&number.locale){this.plan=number.plan;this.locale=number.locale;this.destinationPlan=number.destinationPlan;this.destinationLocale=number.destinationLocale;if(options&&typeof options.onLoad==="function"){options.onLoad(this)}return}}new PhoneLocale({locale:options&&options.locale,mcc:options&&options.mcc,sync:this.sync,loadParams:this.loadParams,onLoad:ilib.bind(this,function(loc){this.locale=this.destinationLocale=loc;new NumberingPlan({locale:this.locale,sync:this.sync,loadParms:this.loadParams,onLoad:ilib.bind(this,function(plan){this.plan=this.destinationPlan=plan;if(typeof number==="object"){return}Utils.loadData({name:"states.json",object:PhoneNumber,locale:this.locale,sync:this.sync,loadParams:JSUtils.merge(this.loadParams,{returnOne:true}),callback:ilib.bind(this,function(stdata){if(!stdata){stdata=PhoneNumber._defaultStates}stateData=stdata;regionSettings={stateData:stateData,plan:plan,handler:PhoneHandlerFactory(this.locale,plan)};number="^"+number.replace(/\^/g,"");number=PhoneNumber._stripFormatting(number);this._parseNumber(number,regionSettings,options)})})})})})})};PhoneNumber.parseImsi=function(imsi,options){var sync=true,loadParams={},fields={};if(!imsi){return undefined}if(options){if(typeof options.sync!=="undefined"){sync=options.sync==true}if(options.loadParams){loadParams=options.loadParams}}if(ilib.data.mnc){fields=PhoneNumber._parseImsi(ilib.data.mnc,imsi);if(options&&typeof options.onLoad==="function"){options.onLoad(fields)}}else{Utils.loadData({name:"mnc.json",object:PhoneNumber,nonlocale:true,sync:sync,loadParams:loadParams,callback:ilib.bind(this,function(data){ilib.data.mnc=data;fields=PhoneNumber._parseImsi(data,imsi);if(options&&typeof options.onLoad==="function"){options.onLoad(fields)}})})}return fields};PhoneNumber._parseImsi=function(data,imsi){var ch,i,currentState,end,handlerMethod,state=0,newState,fields={},lastLeaf,consumed=0;currentState=data;if(!currentState){return undefined}i=0;while(i<imsi.length){ch=PhoneNumber._getCharacterCode(imsi.charAt(i));if(ch>=0){newState=currentState.s&&currentState.s[ch];if(typeof newState==="object"){if(typeof newState.l!=="undefined"){lastLeaf=newState;consumed=i}currentState=newState;i++}else{if((typeof newState==="undefined"||newState===0||typeof newState==="object"&&typeof newState.l==="undefined")&&lastLeaf){newState=lastLeaf;i=consumed}if(typeof newState==="number"&&newState||typeof newState==="object"&&typeof newState.l!=="undefined"){var stateNumber=typeof newState==="number"?newState:newState.l;handlerMethod=PhoneNumber._states[stateNumber];if(handlerMethod==="area"){end=i+1}else{end=6}fields.mcc=imsi.substring(0,3);fields.mnc=imsi.substring(3,end);fields.msin=imsi.substring(end);return fields}else{if(imsi.length>=6){fields.mcc=imsi.substring(0,3);fields.mnc=imsi.substring(3,6);fields.msin=imsi.substring(6)}return fields}}}else if(ch===-1){i++}else{i++}}if(i>=imsi.length&&imsi.length>=6){fields.mcc=imsi.substring(0,3);fields.mnc=imsi.substring(3,6);fields.msin=imsi.substring(6)}else{fields=undefined}return fields};PhoneNumber._stripFormatting=function(str){var ret="";var i;for(i=0;i<str.length;i++){if(PhoneNumber._getCharacterCode(str.charAt(i))>=-1){ret+=str.charAt(i)}}return ret};PhoneNumber._getCharacterCode=function(ch){if(ch>="0"&&ch<="9"){return ch-"0"}switch(ch){case"+":return 10;case"*":return 11;case"#":return 12;case"^":return 13;case"p":case"P":case"t":case"T":case"w":case"W":return-1;case"x":case"X":case",":case";":return-1}return-2};PhoneNumber._states=["none","unknown","plus","idd","cic","service","cell","area","vsc","country","personal","special","trunk","premium","emergency","service2","service3","service4","cic2","cic3","start","local"];PhoneNumber._fieldOrder=["vsc","iddPrefix","countryCode","trunkAccess","cic","emergency","mobilePrefix","serviceCode","areaCode","subscriberNumber","extension"];PhoneNumber._defaultStates={s:[0,21,21,21,21,21,21,21,21,21,0,0,0,{s:[{s:[3],l:12},21,21,21,21,21,21,21,21,21,2]}]};PhoneNumber.prototype={_parseOtherCountry:function(number,regionData,options,countryCode){new PhoneLocale({locale:this.locale,countryCode:countryCode,sync:this.sync,loadParms:this.loadParams,onLoad:ilib.bind(this,function(loc){this.destinationLocale=loc;Utils.loadData({name:"states.json",object:PhoneNumber,locale:this.destinationLocale,sync:this.sync,loadParams:JSUtils.merge(this.loadParams,{returnOne:true}),callback:ilib.bind(this,function(stateData){if(!stateData){stateData=PhoneNumber._defaultStates}new NumberingPlan({locale:this.destinationLocale,sync:this.sync,loadParms:this.loadParams,onLoad:ilib.bind(this,function(plan){this.destinationPlan=plan;var regionSettings={stateData:stateData,plan:plan,handler:PhoneHandlerFactory(this.destinationLocale,plan)};if(!plan.getSkipTrunk()){number="^"+number}this._parseNumber(number,regionSettings,options)})})})})})})},_parseNumber:function(number,regionData,options){var i,ch,regionSettings,newState,dot,handlerMethod,result,currentState=regionData.stateData,lastLeaf=undefined,consumed=0;regionSettings=regionData;dot=14;i=0;while(i<number.length){ch=PhoneNumber._getCharacterCode(number.charAt(i));if(ch>=0){newState=currentState.s&&currentState.s[ch];if(!newState&&currentState.s&&currentState.s[dot]){newState=currentState.s[dot]}if(typeof newState==="object"&&i+1<number.length){if(typeof newState.l!=="undefined"){lastLeaf=newState;consumed=i}currentState=newState;i++}else{if((typeof newState==="undefined"||newState===0||typeof newState==="object"&&typeof newState.l==="undefined")&&lastLeaf){newState=lastLeaf;i=consumed;consumed=0;lastLeaf=undefined}if(typeof newState==="number"&&newState||typeof newState==="object"&&typeof newState.l!=="undefined"){var stateNumber=typeof newState==="number"?newState:newState.l;handlerMethod=PhoneNumber._states[stateNumber];if(number.charAt(0)==="^"){result=regionSettings.handler[handlerMethod](number.slice(1),i-1,this,regionSettings)}else{result=regionSettings.handler[handlerMethod](number,i,this,regionSettings)}number=result.number;i=consumed=0;lastLeaf=undefined;currentState=regionSettings.stateData;if(result.countryCode!==undefined){this._parseOtherCountry(number,regionData,options,result.countryCode);return}else if(result.table!==undefined){Utils.loadData({name:result.table+".json",object:PhoneNumber,nonlocale:true,sync:this.sync,loadParams:this.loadParams,callback:ilib.bind(this,function(data){if(!data){data=PhoneNumber._defaultStates}regionSettings={stateData:data,plan:regionSettings.plan,handler:regionSettings.handler};this._parseNumber(number,regionSettings,options)})});return}else if(result.skipTrunk!==undefined){ch=PhoneNumber._getCharacterCode(regionSettings.plan.getTrunkCode());currentState=currentState.s&&currentState.s[ch]}}else{handlerMethod=typeof newState==="number"?"none":"local";if(number.charAt(0)==="^"){result=regionSettings.handler[handlerMethod](number.slice(1),i-1,this,regionSettings)}else{result=regionSettings.handler[handlerMethod](number,i,this,regionSettings)}break}}}else if(ch===-1){i++}else{i++}}if(i>=number.length&&currentState!==regionData.stateData){handlerMethod=typeof currentState.l==="undefined"||currentState===0?"none":"local";if(number.charAt(0)==="^"){result=regionSettings.handler[handlerMethod](number.slice(1),i-1,this,regionSettings)}else{result=regionSettings.handler[handlerMethod](number,i,this,regionSettings)}}if(this.onLoad){this.onLoad(this)}},_getPrefix:function(){return this.areaCode||this.serviceCode||this.mobilePrefix||""},_hasPrefix:function(){return this._getPrefix()!==""},_xor:function(left,right){if(left===undefined&&right===undefined||left!==undefined&&right!==undefined){return false}else{return true}},_join:function(){var fieldName,formatted="";try{for(var field in PhoneNumber._fieldOrder){if(typeof field==="string"&&typeof PhoneNumber._fieldOrder[field]==="string"){fieldName=PhoneNumber._fieldOrder[field];if(this[fieldName]!==undefined){formatted+=this[fieldName]}}}}catch(e){throw e}return formatted},compare:function(other){var match=100,FRdepartments={590:1,594:1,596:1,262:1},ITcountries={378:1,379:1},thisPrefix,otherPrefix,currentCountryCode=0;if(typeof this.locale.region==="string"){currentCountryCode=this.locale._mapRegiontoCC(this.locale.region)}if(!this.subscriberNumber||!other.subscriberNumber||this.subscriberNumber!==other.subscriberNumber){return 0}if(this._xor(this.extension,other.extension)||this.extension!==other.extension){return 0}if(this._xor(this.countryCode,other.countryCode)){switch(this.locale.getRegion()){case"FR":if(this.countryCode in FRdepartments||other.countryCode in FRdepartments){if(this.areaCode!==other.areaCode||this.mobilePrefix!==other.mobilePrefix){match-=100}}else{match-=16}break;case"IT":if(this.countryCode in ITcountries||other.countryCode in ITcountries){if(this.areaCode!==other.areaCode){match-=100}}else{match-=16}break;default:match-=16;if(this.countryCode!==undefined&&this.countryCode!==currentCountryCode||other.countryCode!==undefined&&other.countryCode!==currentCountryCode){match-=16}}}else if(this.countryCode!==other.countryCode){if(other.countryCode==="33"||this.countryCode==="33"){if(this.countryCode in FRdepartments||other.countryCode in FRdepartments){if(this.areaCode!==other.areaCode||this.mobilePrefix!==other.mobilePrefix){match-=100}}else{match-=100}}else if(this.countryCode==="39"||other.countryCode==="39"){if(this.countryCode in ITcountries||other.countryCode in ITcountries){if(this.areaCode!==other.areaCode){match-=100}}else{match-=100}}else{match-=100}}if(this._xor(this.serviceCode,other.serviceCode)){match-=20}else if(this.serviceCode!==other.serviceCode){match-=100}if(this._xor(this.mobilePrefix,other.mobilePrefix)){match-=20}else if(this.mobilePrefix!==other.mobilePrefix){match-=100}if(this._xor(this.areaCode,other.areaCode)){match-=12}else if(this.areaCode!==other.areaCode){match-=100}thisPrefix=this._getPrefix();otherPrefix=other._getPrefix();if(thisPrefix&&otherPrefix&&thisPrefix!==otherPrefix){match-=100}if(match<0){match=0}else if(match>100){match=100}return match},equals:function equals(other){if(other.locale&&this.locale&&!this.locale.equals(other.locale)&&(!this.countryCode||!other.countryCode)){return false}for(var p in other){if(p!==undefined&&this[p]!==undefined&&typeof this[p]!=="object"){if(other[p]===undefined){return false}if(this[p]!==other[p]){return false}}}for(var p in other){if(p!==undefined&&other[p]!==undefined&&typeof other[p]!=="object"){if(this[p]===undefined){return false}if(this[p]!==other[p]){return false}}}return true},_doNormalize:function(options,norm,homeLocale,currentLocale,currentPlan,destinationLocale,destinationPlan,sync,loadParams){var formatted="";if(!norm.invalid&&options&&options.assistedDialing){if(norm.subscriberNumber&&(!options.manualDialing||norm.iddPrefix||norm.countryCode||norm.trunkAccess)){if(currentLocale.getRegion()!==destinationLocale.getRegion()){if(!norm._hasPrefix()&&options.defaultAreaCode&&destinationLocale.getRegion()===homeLocale.getRegion()&&(!destinationPlan.getFieldLength("minLocalLength")||norm.subscriberNumber.length>=destinationPlan.getFieldLength("minLocalLength"))){norm.areaCode=options.defaultAreaCode;if(!destinationPlan.getSkipTrunk()&&destinationPlan.getTrunkCode()){norm.trunkAccess=destinationPlan.getTrunkCode()}}if(norm.trunkAccess&&destinationPlan.getSkipTrunk()){delete norm.trunkAccess}if(options.sms){if(homeLocale.getRegion()==="US"&&currentLocale.getRegion()!=="US"){if(destinationLocale.getRegion()!=="US"){norm.iddPrefix="011";norm.countryCode=norm.countryCode||homeLocale._mapRegiontoCC(destinationLocale.getRegion())}else if(options.networkType==="cdma"){delete norm.iddPrefix;delete norm.countryCode;if(norm.areaCode){norm.trunkAccess="1"}}else if(norm.areaCode){norm.iddPrefix="+";norm.countryCode="1";delete norm.trunkAccess}}else{norm.iddPrefix=options.networkType==="cdma"?currentPlan.getIDDCode():"+";norm.countryCode=norm.countryCode||homeLocale._mapRegiontoCC(destinationLocale.region)}}else if(norm._hasPrefix()&&!norm.countryCode){norm.countryCode=homeLocale._mapRegiontoCC(destinationLocale.region)}if(norm.countryCode&&!options.sms){norm.iddPrefix=options.networkType==="cdma"?currentPlan.getIDDCode():"+"}}else{if(options.defaultAreaCode){if(destinationPlan.getPlanStyle()==="open"){if(!norm.trunkAccess&&norm._hasPrefix()&&destinationPlan.getTrunkCode()){norm.trunkAccess=destinationPlan.getTrunkCode()}}else{if(!norm._hasPrefix()){if(destinationLocale.getRegion()===homeLocale.getRegion()){norm.areaCode=options.defaultAreaCode;if(destinationPlan.getTrunkRequired()&&destinationPlan.getTrunkCode()){norm.trunkAccess=norm.trunkAccess||destinationPlan.getTrunkCode()}}}else{if(destinationPlan.getTrunkRequired()&&destinationPlan.getTrunkCode()){norm.trunkAccess=norm.trunkAccess||destinationPlan.getTrunkCode()}}}}if(options.sms&&homeLocale.getRegion()==="US"&&currentLocale.getRegion()!=="US"){norm.iddPrefix="011";if(destinationPlan.getSkipTrunk()&&norm.trunkAccess){delete norm.trunkAccess}}else if(norm.iddPrefix||norm.countryCode){delete norm.iddPrefix;delete norm.countryCode;if((destinationPlan.getPlanStyle()==="open"||destinationPlan.getTrunkRequired())&&destinationPlan.getTrunkCode()){norm.trunkAccess=destinationPlan.getTrunkCode()}}}}}else if(!norm.invalid){if(!norm._hasPrefix()&&options&&options.defaultAreaCode&&destinationLocale.getRegion()===homeLocale.region){norm.areaCode=options.defaultAreaCode}if(!norm.countryCode&&norm._hasPrefix()){norm.countryCode=homeLocale._mapRegiontoCC(destinationLocale.getRegion())}if(norm.countryCode){if(options&&options.networkType&&options.networkType==="cdma"){norm.iddPrefix=currentPlan.getIDDCode()}else{norm.iddPrefix="+"}if(destinationPlan.getSkipTrunk()&&norm.trunkAccess){delete norm.trunkAccess}else if(!destinationPlan.getSkipTrunk()&&!norm.trunkAccess&&destinationPlan.getTrunkCode()){norm.trunkAccess=destinationPlan.getTrunkCode()}}}formatted=norm._join();return formatted},_doReparse:function(options,norm,homeLocale,currentLocale,currentPlan,destinationLocale,destinationPlan,sync,loadParams,callback){var formatted,tempRegion;if(options&&options.assistedDialing&&!norm.trunkAccess&&!norm.iddPrefix&&norm.subscriberNumber&&norm.subscriberNumber.length>destinationPlan.getFieldLength("maxLocalLength")){new PhoneNumber("+"+this._join(),{locale:this.locale,sync:sync,loadParms:loadParams,onLoad:ilib.bind(this,function(data){tempRegion=data.countryCode&&data.locale._mapCCtoRegion(data.countryCode);if(tempRegion&&tempRegion!=="unknown"&&tempRegion!=="SG"){norm=data;destinationLocale=data.destinationLocale;destinationPlan=data.destinationPlan}formatted=this._doNormalize(options,norm,homeLocale,currentLocale,currentPlan,destinationLocale,destinationPlan,sync,loadParams);if(typeof callback==="function"){callback(formatted)}})})}else if(options&&options.assistedDialing&&norm.invalid&&currentLocale.region!==norm.locale.region){new PhoneNumber(this._join(),{locale:currentLocale,sync:sync,loadParms:loadParams,onLoad:ilib.bind(this,function(data){if(data&&!data.invalid){norm=data}formatted=this._doNormalize(options,norm,homeLocale,currentLocale,currentPlan,destinationLocale,destinationPlan,sync,loadParams);if(typeof callback==="function"){callback(formatted)}})})}else{formatted=this._doNormalize(options,norm,homeLocale,currentLocale,currentPlan,destinationLocale,destinationPlan,sync,loadParams);if(typeof callback==="function"){callback(formatted)}}},normalize:function(options){var norm,sync=true,loadParams={};if(options){if(typeof options.sync!=="undefined"){sync=options.sync==true}if(options.loadParams){loadParams=options.loadParams}}norm=new PhoneNumber(this);var normalized;if(options&&(typeof options.mcc!=="undefined"||typeof options.country!=="undefined")){new PhoneLocale({mcc:options.mcc,countryCode:options.countryCode,locale:this.locale,sync:sync,loadParams:loadParams,onLoad:ilib.bind(this,function(loc){new NumberingPlan({locale:loc,sync:sync,loadParms:loadParams,onLoad:ilib.bind(this,function(plan){this._doReparse(options,norm,this.locale,loc,plan,this.destinationLocale,this.destinationPlan,sync,loadParams,function(fmt){normalized=fmt;if(options&&typeof options.onLoad==="function"){options.onLoad(fmt)}})})})})})}else{this._doReparse(options,norm,this.locale,this.locale,this.plan,this.destinationLocale,this.destinationPlan,sync,loadParams,function(fmt){normalized=fmt;if(options&&typeof options.onLoad==="function"){options.onLoad(fmt)}})}return normalized}};module.exports=PhoneNumber;