var ilib=require("./ilib.js");var Locale=require("./Locale.js");var JSUtils=require("./JSUtils.js");var Utils={};Utils.mergeLocData=function(prefix,locale,replaceArrays,returnOne){var data=undefined;var loc=locale||new Locale();var foundLocaleData=false;var property=prefix;var mostSpecific;data=ilib.data[prefix]||{};mostSpecific=data;if(loc.getLanguage()){property=prefix+"_"+loc.getLanguage();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getRegion()){property=prefix+"_"+loc.getRegion();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getLanguage()){property=prefix+"_"+loc.getLanguage();if(loc.getScript()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getScript();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getRegion()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getRegion();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}}if(loc.getRegion()&&loc.getVariant()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getVariant();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getLanguage()&&loc.getScript()&&loc.getRegion()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getScript()+"_"+loc.getRegion();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getLanguage()&&loc.getRegion()&&loc.getVariant()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getRegion()+"_"+loc.getVariant();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}if(loc.getLanguage()&&loc.getScript()&&loc.getRegion()&&loc.getVariant()){property=prefix+"_"+loc.getLanguage()+"_"+loc.getScript()+"_"+loc.getRegion()+"_"+loc.getVariant();if(ilib.data[property]){foundLocaleData=true;data=JSUtils.merge(data,ilib.data[property],replaceArrays);mostSpecific=ilib.data[property]}}return foundLocaleData?returnOne?mostSpecific:data:undefined};Utils.getLocFiles=function(locale,name){var dir="";var files=[];var filename=name||"resources.json";var loc=locale||new Locale();var language=loc.getLanguage();var region=loc.getRegion();var script=loc.getScript();var variant=loc.getVariant();files.push(filename);if(language){dir=language+"/";files.push(dir+filename)}if(region){dir="und/"+region+"/";files.push(dir+filename)}if(language){if(script){dir=language+"/"+script+"/";files.push(dir+filename)}if(region){dir=language+"/"+region+"/";files.push(dir+filename)}}if(region&&variant){dir="und/"+region+"/"+variant+"/";files.push(dir+filename)}if(language&&script&&region){dir=language+"/"+script+"/"+region+"/";files.push(dir+filename)}if(language&&region&&variant){dir=language+"/"+region+"/"+variant+"/";files.push(dir+filename)}if(language&&script&&region&&variant){dir=language+"/"+script+"/"+region+"/"+variant+"/";files.push(dir+filename)}return files};Utils._callLoadData=function(files,sync,params,callback){if(typeof ilib._load==="function"){return ilib._load(files,sync,params,callback)}else if(typeof ilib._load==="object"&&typeof ilib._load.loadFiles==="function"){return ilib._load.loadFiles(files,sync,params,callback)}return undefined};Utils.loadData=function(params){var name="resources.json",object=undefined,locale=new Locale(ilib.getLocale()),sync=false,type=undefined,loadParams={},callback=undefined,nonlocale=false,replace=false,basename;if(!params||typeof params.callback!=="function"){return}if(params.name){name=params.name}if(params.object){object=params.object}if(params.locale){locale=typeof params.locale==="string"?new Locale(params.locale):params.locale}if(params.type){type=params.type}if(params.loadParams){loadParams=params.loadParams}if(params.sync){sync=params.sync}if(params.nonlocale){nonlocale=!!params.nonlocale}if(typeof params.replace==="boolean"){replace=params.replace}callback=params.callback;if(object&&!object.cache){object.cache={}}if(!type){var dot=name.lastIndexOf(".");type=dot!==-1?name.substring(dot+1):"text"}var spec=(!nonlocale&&locale.getSpec().replace(/-/g,"_")||"root")+","+name+","+String(JSUtils.hashCode(loadParams));if(!object||typeof object.cache[spec]==="undefined"){var data,returnOne=loadParams&&loadParams.returnOne;if(type==="json"){basename=name.substring(0,name.lastIndexOf("."));if(nonlocale){basename=basename.replace(/\//g,".").replace(/[\\\+\-]/g,"_");data=ilib.data[basename]}else{data=Utils.mergeLocData(basename,locale,replace,returnOne)}if(data){if(object){object.cache[spec]=data}callback(data);return}}if(typeof ilib._load!=="undefined"){var files=nonlocale?[name||"resources.json"]:Utils.getLocFiles(locale,name);if(type!=="json"){loadParams.returnOne=true}Utils._callLoadData(files,sync,loadParams,ilib.bind(this,function(arr){if(type==="json"){data=ilib.data[basename]||{};for(var i=0;i<arr.length;i++){if(typeof arr[i]!=="undefined"){data=loadParams.returnOne?arr[i]:JSUtils.merge(data,arr[i],replace)}}if(object){object.cache[spec]=data}callback(data)}else{var i=arr.length-1;while(i>-1&&!arr[i]){i--}if(i>-1){if(object){object.cache[spec]=arr[i]}callback(arr[i])}else{callback(undefined)}}}))}else{if(type==="json"){data=ilib.data[basename]}if(object&&data){object.cache[spec]=data}callback(data)}}else{callback(object.cache[spec])}};module.exports=Utils;